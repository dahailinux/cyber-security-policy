# cyber-security-policy
运维安全手册

安全防御建设到一定等级就够了，在做就提高安全运营成本了，也影响业务的方便和高效发展，所以就转做攻击，以攻代守，用白盒方式来找自己的漏洞是更好的防御。
7.1 远程运维办公规范准则
所有工作必须先连接VPN，应用配置白名单授权，才能开始工作。
不允许使用国产软件，会被政府监控，进行远程电子取证；
不允许直连服务器，只能通过堡垒机或虚拟应用或vpn连接；
不允许接触同行业其他公司，不许和其他人说工作相关事项，防信息泄露；
不允许把工作信息公开在外网，比如博客，GitHub，自己的电脑，甚至写在纸上。
不允许做任何渗透操作，不允许安装渗透工具，不允许无谓的ping操作；
不允许远程办公员工拍照一切工作内容；
办公电脑应及时更新补丁和杀软病毒库；
办公电脑不存放敏感数据，工作数据全部存在服务器端，访问服务端遵循零信任机制；
办公电脑不缓存密码，比如Xshell或浏览器密码，这些密码对黑客来说都是明文的；
办公电脑下载的所有文件要经过云查杀后才能使用，不允许从服务器下载文件，
办公电脑不允许安装国产软件，防止警方远程电子取证；
遵循telegram使用注意事项，所有发送的附件都需要加密；
离开电脑要锁屏，下班必须关机，防止黑客长时间远控；
离职后重装电脑系统；
公司不会把整个业务链都给远程办公人员做，防止对手公司掌握完整系统架构；


7.2 办公账号安全管理策略
使用子账号工作，主账号只负责分权，并且做好最小化和白名单配置；
主账号统一一人保管，做多因素验证和IP白名单，遵循密码策略；
开通子账号，赋予角色和权限，专人专号原则；
员工离职前，将其所有账号先注销在删除，取消白名单IP；
部署单点登录系统，实现账密对远程人员隐藏，并且以此登录即可登录所有办公应用该系统；
建设运维管理平台，实现对远程运维所有操作都有记录，可做基于账号的三权分立；
数据库的root权限，严格限制登录ip，并部署数据库三层安全架构，防止爆破；


7.3 服务器强制行为管控
VPN接入安全配置，修改默认端口，隐藏其他端口，监控登录用户及非法IP；
远程办公人员禁止访问配置中心、查看密码，密码也不能存在代码里；
禁用危险指令：mysqldump，extrabackup，rm 换成 mv，禁用rm -rf * ，禁止mkfs.ext3等格式化命令，禁止给脚本777权限，禁止删除系统日志，禁止任意命令 > /dev/sda，redis的keys，mysql的delete和drop；
用密钥代替密码，防爆破，防止密码泄露，密钥只保存在服务器上；
禁止安装软件和命令，卸载不需要的脚本语言（go、php等）；
禁止做无谓的ping服务器；
不要以明文密码登录数据库或其他应用，要隐藏密码，防止黑客窃取
重要服务器禁止远程办公人员访问，直接配置黑名单；
每3个月修改一次密码，因为目前计算机性能3个月可破解一个强密码；
7.4 行为审计安全运营
部署SIEM审计系统，包括堡垒机，系统日志，应用程序日志等；
每天审查操作日志，发现异常行为及时处理；
部署“敏感信息挖掘系统”，防止员工把代码、密码或敏感信息传到网上；
定期检查accesskey、token、key泄露；
远程办公运维安全手册
一、        概述
远程办公已成为互联网公司常态，安全问题随之而来，为保障运维团队安全生产，需要遵循如下安全规范准则；
二、        设计原则和目的
2.1根据10年菠菜行业攻击与被攻击及防御经验，设计出来此方案；
2.2 规范远程办公人员工作行为，加强B端系统的安全防护；
三、        详细运维安全规范准则
3.1 远程运维办公规范准则
3.1.1 所有工作必须先连接VPN，应用配置白名单授权，才能开始工作。
3.1.2 不允许使用国产软件，会被政府监控，进行远程电子取证；
3.1.3 不允许直连服务器，只能通过堡垒机或虚拟应用或vpn连接；
3.1.4 不允许接触同行业其他公司，不许和其他人说工作相关事项，防信息泄露；
3.1.5 不允许把工作信息公开在外网，比如博客，GitHub，自己的电脑，甚至写在纸上。
3.1.6 不允许做任何渗透操作，不允许安装渗透工具，不允许无谓的ping操作；
3.1.7 不允许远程办公员工拍照一切工作内容；
3.1.8 办公电脑应及时更新补丁和杀软病毒库；
3.1.9 办公电脑不存放敏感数据，工作数据全部存在服务器端，访问服务端遵循零信任机制；
3.1.10 办公电脑不缓存密码，比如Xshell或浏览器密码，这些密码对黑客来说都是明文的；
3.1.11 办公电脑下载的所有文件要经过云查杀后才能使用，不允许从服务器下载文件，
3.1.12 办公电脑不允许安装国产软件，防止警方远程电子取证；
3.1.13 遵循telegram使用注意事项，所有发送的附件都需要加密；
3.1.14 离开电脑要锁屏，下班必须关机，防止黑客长时间远控；
3.1.15 离职后重装电脑系统；
3.1.16 公司不会把整个业务链都给远程办公人员做，防止对手公司掌握完整系统架构；
3.2 办公账号安全管理策略
3.2.1 使用子账号工作，主账号只负责分权，并且做好最小化和白名单配置；
3.2.2 主账号统一一人保管，做多因素验证和IP白名单，遵循密码策略；
3.2.3 开通子账号，赋予角色和权限，专人专号原则；
3.2.4 员工离职前，将其所有账号先注销在删除，取消白名单IP；
3.2.5 部署单点登录系统，实现账密对运维隐藏，并且一次登录即可登录所有办公应用系统；
3.2.6 建设运维管理平台，实现对远程运维所有操作都有记录，可做基于账号的三权分立；
3.2.7 数据库的root权限，严格限制登录ip，并部署数据库三层安全架构，防止爆破；
3.3 服务器强制行为管控
3.3.1 VPN接入安全配置，修改默认端口，隐藏其他端口，监控登录用户及非法IP；
3.3.2 远程办公人员禁止访问配置中心、查看密码，密码也不能存在代码里；
3.3.3 禁用危险指令：mysqldump，extrabackup，rm 换成 mv，禁用rm -rf * ，禁止mkfs.ext3等格式化命令，禁止给脚本777权限，禁止删除系统日志，禁止任意命令 > /dev/sda，redis的keys，mysql的delete和drop；
3.3.4 用密钥代替密码，防爆破，防止密码泄露，密钥只保存在服务器上；
3.3.5 禁止安装软件和命令，卸载不需要的脚本语言（go、php等）；
3.3.6 禁止做无谓的ping服务器；
3.3.7 不要以明文密码登录数据库或其他应用，要隐藏密码，防止黑客窃取
3.3.8 重要服务器禁止远程办公人员访问，直接配置黑名单；
3.3.9 每3个月修改一次密码，因为目前计算机性能3个月可破解一个强密码；
3.4 行为审计安全运营
3.4.1 部署SIEM审计系统，包括堡垒机，系统日志，应用程序日志等；
3.4.2 每天审查操作日志，发现异常行为及时处理；
3.4.3 部署“敏感信息挖掘系统”，防止员工把代码、密码或敏感信息传到网上；
3.4.4 定期检查accesskey、token、key泄露；
四、        总结
结合现有的安全系统部署这套方案，再加上日常安全运营便可提升远程办公人员对B端系统的安全；
离职交接注意事项：
1. 所有账号
找回密码方式
验证邮箱
账号里绑定的邮件或手机号；
服务器白名单核实，不能让其在外网访问；
所有服务器木马、后门和反弹shell扫描，防止远控服务器；
vpn、堡垒机等账号清理；最好加上白名单保护；
所有账号禁用或删除或修改密码；
所有对外的核心IP，扫一遍白名单，不能有多余的白名单IP可以访问；
所有他知道的密码，包括公共密码都修改一遍；最好加上二次验证；
2. 搜索互联网上敏感信息，别把敏感信息发到网上
GitHub搜索
博客
所有互联网论坛进行搜索，搜索关键字就行；
3. 清理token；
把他有权限的token都重置一遍，不然，token泄露是非常危险的。等于所有权限都泄露了；
4. 所有对外的后台，全部删除他的账号，包括运维后台和办公后台，最好用白名单；
5. 他所用到的应用都统计一下，然后全部禁用账号或修改密码；
6. 他的个人电脑先关机，后期重做系统，不要开机。避免远控PC机，用办公电脑的权限做操作；
7. 小飞机退群，最好是小飞机注销；凡是和工作相关的小飞机都处理；并且小飞机对应的手机号要回收，并且找回密码的验证方式也要收回；
8. 不准有自己个人的邮箱，全部交工，并且找回密码的手机号也提交；
9. 有和厂家沟通的qq号或其他IM，也要交工，防止在和厂家沟通。并且告诉厂家，只有这一个qq号是认可的，不允许在使用其他qq号去沟通；
10. 最好删除和同事的一切联系方式，全体删除和离职员工的所有方式；



查找木马后门路径
木马都有自我恢复功能，在处理的时候，要一次性执行所有指令清除木马；
除了rootkit类似的隐藏木马，其他都能查出来；
遍历Linux系统下的所有文件，并查看文件类型，用file指令，如果是elf类型的文件就输出，看他是不是异常的疑似木马；
crontab -l
/etc/crontab
/etc/profile ->/etc/enviroment -->$HOME/.profile -->$HOME/.env
/etc/init.d/
/etc/rc.d/init.d
/etc/rc.d/{init.d,rc{1,2,3,4,5}.d}/
/etc/rc.local
/etc/profile
/etc /bashrc
$HOME/.bash_profile
$HOME/.bashrc
$HOME/.bash_login
$HOME/.profile
~/.bash_logout
/tmp
/dev/shm
/etc/passwd

ps -ef看没用的进程
netstat -anplt 看没用的目标IP
看服务器支持什么开发语言，有什么应用，找应用对应数据目录下的脚本（尤其是用户上传目录和头像等目录）；
每个用户默认的家目录，因为他执行rce，只能在自己的家目录生效；
全盘查找elf类型的文件
last, lastlog
grep -i Accepted /var/log/secure
/var/spool/cron/
/etc/cron.hourly
/etc/crontab
find / -ctime 1
/usr/lib/systemd/system
/etc/systemd/system
chkconfig --list

检查/etc/passwd和/etc/shadow文件，是否有可疑用户
检查临时目录/tmp、/vat/tmp、/dev/shm，这些目录权限是1777，容易被上传木马文件
查看自启动的服务
pstree
lsof： 1. 进程使用的文件， 2. 文件被哪个进程使用，3. 使用某个端口的进程， 4. 系统打开的端口
iftop 监控每个socket使用的网络流量
nethogs 监控每个进程使用的网络流量
strings输出文件中可打印的字符
/var/spool/cron/root
/var/spool/cron/crontabs/root
/var/spool/anacron/cron.{daily，weekly，monthly}
/etc/anacrontab
如果有php防止是webshell


其余的杀毒软件，只能用在下线机器上，进行溯源使用：
clamav杀毒引擎、rkhunter、chkrootkit
find -type f -name *.php -exec chmod 444 {} ;
grep -r –include=*.php '[^a-z]eval($_POST' . > grep.txt
grep -r –include=*.php 'file_put_contents(。*$_POST[.*]);' . > grep.txt

后门查找
/etc/passwd
ssh公钥删除没用的
visudo
find / -perm /4000  找所有suid文件
防止ssh软连接，查找无用的开放端口
有可能把sshd等命令已经替换了，都替换成了带有后门的程序了。
有可能把库文件都给替换了；
w
uptime
last
lastlog
lastb
who
strings /usr/bin/.sshd | egrep '[1-9]{1,3}.[1-9]{1,3}.'
执行last,lastlog命令，查看最近登录的账户和登录时间，锁定异常账户。
执行grep -i Accepted /var/log/secure命令，查看远程登录成功的IP地址。
执行以下命令，查找计划任务。
/var/spool/cron/
/etc/cron.hourly
/etc/crontab
执行find / -ctime 1通过文件状态最后修改时间来查找木马文件。
检查/etc/passwd和/etc/shadow文件，确认是否有可疑用户。
检查临时目录/tmp、/vat/tmp、/dev/shm下的文件，这些目录权限是1777，容易被上传木马文件。
查看端口对外的服务日志是否存在异常，例如：tomcat、nginx。
执行service --status-all | grep running，查看当前运行的服务中是否存在异常。
执行chkconfig --list | grep :on，查看自启动的服务中是否存在异常。
执行ls -lt /etc/init.d/ | head，查看是否有异常启动脚本
1、root的历史命令
histroy
2、打开/home各帐号目录下的.bash_history，查看普通帐号的历史命令
/var/log/secure
/var/log/message
/var/log/yum.log
应急响应实战笔记：
https://websec.readthedocs.io/zh/latest/defense/emergency.html

学习能力总结：
学习一个知识分4遍学习：
1. 掌握整体架构，说到哪里都不会乱，清晰分界线，就像地图；
2. 掌握每段内容，了解细节，就像知道每个省具体是什么；
3. 掌握详细细节，具体细节研究，就像每个城市和市区研究；
4. 灵活运用，把技术运用在实际当中，比如汇编利用在病毒分析和ollaydbg里；

学习能力总结：
学习一个知识分4遍学习：
1. 掌握整体架构，说到哪里都不会乱，清晰分界线，就像地图；
2. 掌握每段内容，了解细节，就像知道每个省具体是什么；
3. 掌握详细细节，具体细节研究，就像每个城市和市区研究；
4. 灵活运用，把技术运用在实际当中，比如汇编利用在病毒分析和ollaydbg里；

做安全，就要保证最小化原则，尤其是操作系统最小化，因为只有这样才能不方便黑客，同时也不方便自己了。黑客常用命令都不要有，比如wget/curl/perl等。
进程运行的用户，不要属于sudo 权限的，因为只要拥有sudo 权限，就可以利用git find 等命令直接就提权了。
只要是sudo 组的，通过普通命令就可以提权
提权好的文档，大神之作
一个密码多处使用，就可以提权
Crontab里面的指定文件，如果有root权限，也有普通用户写权限，就可以改配置，加一条命令，让他执行，比如加一条把/bin/bash复制到/tmp ，就可以任意用户执行提权了，或者让他执行一个付权操作，就可以有权限了。
办公室内网，通过远控confluence服务器，直接读取confluence里面所有信息，造成敏感信息泄密。
需要用nids进行监控，看具体的黑客攻击行为。
重要文件千万不能放在nginx或tomcat的网站目录下面，一定要放在另外的文件夹下，防止目录遍历把文件暴漏出去，暴漏出去就被用户下载了。尤其是密码的文件更不能
删除木马前要注意，有的木马是关联到系统文件，必须先备份在删除。最后mv到其他目录在操作最好
经验累积：
1. 服务器出现大量TCP TIME_WAIT连接，成千上万个，尤其是更新后才这样，那就是开发没有很好的关闭端口等原因造成的。
2. 系统性能过高，cpu和内存。那就让开发把多进程和多线程调优一下，系统性能会很低的。
攻击方式，
1. 投放木马
2. 根据开放的端口和应用渗透
3. 社会工程
4. 物理攻击
防御方式：
1. 屏蔽，黑名单
2. 限速
3. 人机识别
4. 只记录日志，不防御
识别攻击方式：
1. 特征码
2. 行为
3. 大数据统计
前端工作流
后端工作流
tcp/ip网络传输的从来都是数据，而不是文件。文件名作为数据流的一部分，尤其是开头的一部分，文件体作为数据流发送出去。
所以服务器从来不是生成一个文件在传输，而是生成文件数据就直接传输，就像模板引擎加载模板文件后，不是生成模板文件再传，而是直接生成数据就传输出来了。
写框架controller的业务逻辑：
1. 加载类
2. 定义变量
3. 验证
4. 执行model
5. 拼接View
6. 返回给用户
一个新的渗透思路：
做人做事基础  +  复制一个挣钱模式  +  （创新的思维）和（天时地利人和）  =  挣大钱
创新我也思考了一下，简单有3种：
1. 初级：打包重组（比如把多种饮料混合成一种，就是一种创新）
2. 中级：换个思路，就能实现创新
3. 高级：真正的发明一个全新的事务
创新思维的概念：
以常人思路和间接为根基，利用创新思维，满足人类需求就可以了；
如下是做人做事的基础：
认识自己
创造力
思维
学习能力
见识
真诚
克制欲望（不能做的就坚决不做不想）
综合利用能力
挣钱的能力
沟通表达能力
健康
美貌
机敏
荣誉（名气）
领导力
专注度（长期的专注做一件事，不被打扰）
克制力（毅力）说不碰毒品或坏习惯就坚决不做
自信心
决心
幽默感
察言观色
忍耐力
判断力（找到最优解）
交朋友的能力
误自大（低调做人）
管住脾气
要有看人的能力
要有一个好环境，决定人的真正思维
创新思维（与人不一样）：
打破传统思维，更适合需求。那就是创新，哪怕改变一点点都是创新，比如拍电视剧，以前一拍就30集，后来编程就拍2集，效果不好就不拍了。更适合需求了。

1. 初级：打包重组
2. 高级：发明一个新事物
3. 逆向思维，换个角度
4. 添加一个新的功能
5. 自动化完成其中一个模块
6. 合并两项，做加法和做减法，都属于创新了；
7. 纵向发展不起来了，横向发展；
8. 使用了一般人不在意，不注意的方法就是创新，比如利用打码平台去找回密码；
9
我该学习的知识：
1. 历史
2. 地理
3. 创新思维的书
4. snow crash（阅读这本书）
5
一切应用程序组成：
1. 头，接口，协议(实现接口)，接受请求
2. 程序代码，被cpu调用执行
3. 框架库
4. 代码库
5. 系统库
6. 另一个程序
Php 架构：
1. Nginx 
2. Fastcgi 
3. 系统类库

1. Fpm
2. Servlet库

1. Php代码
2. 自定义类
3. Laravel框架库

1. Jvm虚拟机
2. Php代码库
3. 系统c库
4. 调用硬件或网络
什么是框架：
1. 基于语言运行的
2. 在语言基础上，独立一套系统
3. 功能齐全，凌驾于语言之上，让语言为他服务，就是一套应用
4. 可具有编写语法和编译规则
5. 可结合tomcat独立运行
6. 有自己的一套管理工具
7. 一切规则都自己自定义
8. 整个操作系统开发个工具为他服务
9. 和jvm 做好沟通，哪里是缓存，哪里是编译。
10
OpenVPN进出不同IP：
外部输入总结：（一切安全就是始于注入）
1. 表单输入数据
2. Ajax提交数据
3. Cookies伪造
4. 其他的web services data
5. 数据库查询结果，提前注入到数据库
6. 服务器变量，提前修改；

国内政府的网安到处黑BC站，黑进去然后拿员工信息；而且故人做远程电子取证；
顾安全公司做电子取证；
顾内鬼，来公司内做内应；
中国政府要远控你的电脑很简单，只要你肉身在国内，你就用国内的运营商，在你下载任何数据或软件时，在你的软件内嵌入免杀木马程序，你一安装，他就能远控你的电脑了。你看到什么，他就能看到什么
查看rpm的文件或包是否被修改：
rpm -Vf /lib64/ld-2.17.so
[root@ha-proxy opt]# rpm -Va openssh*
S.5....T.  c /etc/ssh/sshd_config

这里校验失败才会有内容输出：
S 代表文件大小改变
5 代表md5校验和改变，说明文件内容被修改了
T 代表修改时间发生了变化
其他本例没有显示的关键字还有：
L 代表链接改变
D 代表设备改变
U 代表文件属主改变
G 代表文件属组改变
M 代表文件的访问权限或文件类型发生了改变

安全工具要用正版的，最好是官方正版并且统一使用；
就像不用xshell，而改用secureCRT。
而且要在内网中使用，外网用另外的机器。
运维服务器，一定不要自动登录或者留密码在服务器和history里面。全都是给黑客留后门；
做安全的重点，始终认为你的电脑被远控了，你的服务器网络有肉机，你的应用有0day。
所以你所有的密码都要二次完整，可以用手机验证码，不要再电脑上，因为电脑已经被远控。
内网很容易被渗透进来，因为主机都能随意出网，除非那样办公电脑绝对不出网，内外网电脑分开。
下班后，加强安全，甚至关闭电源，平时可以不用，不允许登录服务器或办公；
要有多种不同程度的防cc方案，不同程度攻击下用不同的，全白名单的用在最后，
以后加白，不要加办公网IP，这是运维常见问题，因为内网大都被黑客控制，加白内网IP，就等于其他电脑也有白名单，最好用vpn，并且二次验证。
只有断外网是最靠谱的，只有内网没有外网，最靠谱。黑客就无法远控了。这个断外网指的是无法出网，也无法从外网访问，也就是端口不映射出去；
应急响应操作：
1. 找到受攻击机器，所有可能受攻击机器
2. 找到黑客ip ，在网络层做黑名单
2. 执行深度安全检测，用任何软件都行
3. 禁止主动出网，阻断黑客远控服务器
4. 删除病毒木马文件，如果是rootkit删除也没用
5. 迁移应用，启用新服务器。
6. 找到重要机器，重点做防御，内外网防火墙策略和安装安骑士
找到入侵源头，找开发和运维进行修复，安全系统会报警
看网络入侵检测系统，找到异常访问主机，定位入侵点
清楚报警，取消噪音
看堡垒机日志，看是不是自己人的操作
执行应急预案，先保证业务稳定运行
不重要机器一旦中木马，可以直接下线
如果入侵源或肉机找到了，立刻断网，如果是办公内网机器就关机
通过蜜罐看攻击源
确认入侵点，根据被入侵机器规律，如果是云账号泄漏，就立即修改云账号，修改密钥，云平台远程桌面做一次远程连接，第二次就需要手机号验证了，敏感操作和登录启用手机验证码，不要在电脑上
查看主机监控，有没有cpu飚高的机器
通过网络层，找到外网能直接访问的ip ，排查是否能被远控。因为反弹shell 已经防住，就剩正向shell 了，机房服务器不允许直接访问，可以在外网加一个代理，因为代理可认为是无漏洞的。
查看所有安全设备的日志，定位入侵点edited 22:50
把漏洞补丁打上22:51
通过威胁情报，获取更多此次入侵信息22:52
扫描病毒样本，多注册几个威胁情报平台
判断入侵类型：判断是否是安全事件，何种安全事件，勒索、挖矿、断网、DoS等等
信息收集：被入侵项目，受害主机数量，补丁情况，简单不定立刻打上，确认是否弱密码，大体架构，对外开放端口，被入侵现象，对业务有什么影响，操作系统版本
木马应用：途径流量，内存，硬盘文件，启动项，库
把网址文件等信息在威胁情报系统上检测
通过内网dns服务器日志，可以看出哪台机器访问外网域名了，就是中木马了
防止中勒索病毒，立即删除病毒文件
找到漏洞点，防止入侵行为反复发生
安全事故类型：
1. Webshell 
2. 发现木马
3. 网络攻击，少量的话，要考虑他配合渗透入侵
4. CPU 飚高
5. 被拖库
6. 被远控
7. Web渗透
8. 爆破
9. 发现后门
10. 被劫持
11. 账号密码被盗
12. 内网被入侵
13. 网页被篡改
对于有些服务器不能断外网的，有个简单的方法。平时断外网，发版要连网时就在脚本里停防火墙，发完后start  .一般跑个脚本就开那么几分钟。
安全4项工作
1. 安全系统建设，配合运维开发配置安全
2. 日常巡检，故障处理，安全培训，补丁管理
3. 应急响应，病毒分析，溯源
4. 渗透测试，黑客思维
分析网络流量和报警Snort、Suricata、Bro其中的一种，HIDS可以选择Ossec
本机分析都尝试发起的网络连接用bro更名为zeek ，看连接哪个域名，发起什么协议，都向哪几台机器发起连接，最终用交换机做ACL屏蔽
防cc攻击：
1. 现在开始统计白名单，真实用户的
2. 统计黑名单，再买一份黑名单，挡不住的时候直接启用黑名单机制。
3. 要有黑名单统计策略
实现ip 层的访问频率限制，用iptables，http层的都可以伪造edited 23:10
根据token来识别，每个接口做访问频率限制23:12
在nginx 上这一套jwt 系统，给玩家分配token，用来识别玩家，进行行为统计
因为每经过一层cc防御系统，都会返回token，所以最好只启用一套
启用token后，要抓网络层ip ，不要抓http层ip23:16
他如果就打这个token接口的话不怕，这个在nginx 上，性能和带宽都相当好，可容纳500万并发
同一接口一分钟请求多次，就黑名单23:19
同一ip 一分钟请求多次就黑名单23:20
用remote_addr获取用户ip，而不要用xff23:30
所有nginx 只允许白名单的cdn 访问，不允许黑客直接访问nginx ，不然直接就打死了，会有xff 欺骗
最前端——CDN节点的Nginx以$remote_addr变量作为访客的真实IP！这是保证不被欺骗XFF的关键：
前端有cdn ，配置后端nginx 限制频率获取$binary_remote_addr真实ip，用上面配置。
一定要在最前端cdn 上配置
proxy_set_header X-Forwarded-For $remote_addr;
这才能防止xff 欺骗
下班后要关机的原因：session不退出，黑客直接就登录了；
内网很多机器被远控了，域控都被拿下了
Confluence 敏感信息自己查一遍，哪些黑客拿到信息后就可以直接利用了
云账号的子账号都加一下登陆二次验证和敏感操作验证，邮箱就行
电脑上最好不要存密码，一旦被远控了，就被利用了，可以用密码服务器，登陆有二次验证，验证要用手机而不是电脑
一切原理就是方便你操作了，也方便黑客远控了
外网机器把重要的几台安装安骑士，因为属于白名单ip
内外网ansible分开21:32
这几次应该是内网进来的，可以看看这些机器谁有这些权限。那就是谁的电脑被黑了
离线的安骑士要重新安装，安装不上的，就得重做系统
Ansible 得建一个分组，所有机房生产服务器在一个组里21:43
Ag 都是没外网两台电脑，办公和上网。21:44
查看上网代理服务器的安骑士和防火墙21:47
安骑士的阿里云账号要有提工单权限21:53
内网搭建dns服务器，所有上网请求都集中，看域名，就知道是否中木马了
日志服务器，把日志都提交到日志服务器，防止黑客清理痕迹，再把history日志加上执行时间。
所有端口都不允许对外，如果允许要有白名单22:02
当前，dns隧道防不了，webshell，员工信息泄漏，22:08
此次目的，运维安全提升一个档次，让黑客花费大成本才能入侵，从而放弃入侵。
在上网代理服务器上安装bro，做网络行为监控。22:15
所有服务器防火墙都检查一遍，内外网都做限制22:21
不出网原则和最小化原则在测试环境就要做，这样再生产才会习惯
任何安全机制，可以先用非强制模式，permissive ，跑出来日志了，二周左右，把正常合法操作都开启允许，其他的都黑名单就行了。
也就是直接全黑名单，但是不知道白名单是谁，就用非强制模式记录就行。比如禁止出网，先用dns记录log，又比如selinux 要限制行为，就开启permissive 模式就行。
密码复杂度是最基本的安全
前端加密，并且包体参数或称数据也加密，并且加签，后端验签
七点运维架构：
1. client  客户端
2. CDN    CDN防攻击
3. WAF    自己定制waf防御
4. Nginx   机房添加这个的白名单IP，作为机房的代理
5. Firewall   把机房内的F5或lvs的IP映射出来
6. LVS + keepalive  四层代理      或F5
7. Nginx     七层代理，转发接口  或ingress
一般是机房只跑htttp，https在外网跑完，转发进机房都是http
有四层转发，还要有七层转发，因为七层用于反代各个接口，四层就是傻瓜式转发，分担防火墙负载的；
安全工程师和运维职责划分
一、 概述
所谓千里之堤溃于蚁穴，安全同样遵循木桶原理，取决于最薄弱的一环而不是最强的一环，所以安全工作一定不要漏项，一定要完全全面，漏掉那块，那块就会出问题。
二、 最终目的
1. 安全事件不影响到业务稳定性
2. 用户名密码送给黑客，也不担心，他利用不了。
3. 办公电脑送给黑客，让他远控，也影响不到线上业务。
4. 服务器上帮黑客运行木马，他也影响不到业务，带不走资源；
三、 需要的权限
1. 服务器账密
2. 服务器信息列表，每台服务器的作用
3. CDN配置，看看就行
4. 系统架构，大概就行
5. 出安全事件时，我得看监控，包括主机监控，被攻击时看接口监控，用户体验监控一般不用；
6. 应急响应时快速完成我提出的问题和需求；
四、 安全岗位职责
1. 把事情做在事故发生前，而不是事故发生时和发生后
2. 检测整个运维系统的弱点，并提供解决方案解决方案。
3. 模拟黑客渗透，也就是白盒渗透
4. 建设完整的安全系统，目前只有安骑士一个
5. 制作应急方案
6. 7 * 24 紧急应急响应，协调运维、网络、DBA、开发一起紧急处理安全事故；
7. 日常巡检及监控
8. 编写运维安全手册，服务器上线前安全检测，安全意识培训；
9. 安全规章制度的制定，注重风险评估及管理；
10. 病毒分析、病毒发现、黑客IP探测，判断病毒对系统的影响；
11. 协助运维判断是否是安全导致的故障，比如cpu暴增，服务器重启，内网无缘无故有个ping命令
12. 漏洞发现及修复，尤其是在野利用的漏洞（官网都没有发布的）
13. 溯源，知道黑客是怎么进来的（建立在完整安全系统之上）
14. 写cc攻击脚本，测试防御
15. 提供一切安全问题的解决方案
五、 运维需要配合的
如下是运维需要配合的，目前全是我在做，所以体现不出来我和运维的区别：
1. 和开发及网络沟通
2. 部署iptabkes，添加白名单，我会提供模版
3. 安装和修复安骑士
4. 配合我紧急应急操作服务器
5. 遵从运维安全手册（稍后我会颁布）
6. 安装我指定的安全软件，用于安全系统
7. 主机加固配置，应用程序和服务安全配置
8. 删除系统上的木马
六、 总结
安全是相对的，只有做到这些，才能将运维安全层面提升一个档次。提高黑客攻击成本从而放弃渗透。
管理账号的权限，只能有一个人知道，不能大家都知道，比如一个人管理，但是给领导也开一个账号（从来不用）；
也就是管理权限的权限，只能由一个人拥有
使用busybox，里面有很多Linux工具，当黑客把库劫持了，或者命令不能用了，就用这个工具包；
如果不做手机二次验证，同样的渗透，下次还是无法防御

木马后门排查路径

除了rootkit类似的隐藏木马，其他都能查出来；
木马都有自我恢复功能，在处理的时候，要一次性执行所有指令清除木马；
遍历Linux系统下的所有文件，并查看文件类型，用file指令，如果是elf类型的文件就输出，看他是不是异常的疑似木马；
crontab -l
/etc/crontab
/etc/profile ->/etc/enviroment -->$HOME/.profile -->$HOME/.env
/etc/init.d/
/etc/rc.d/init.d
/etc/rc.d/{init.d,rc{1,2,3,4,5}.d}/
/etc/rc.local
/etc/profile
/etc /bashrc
$HOME/.bash_profile
$HOME/.bashrc
$HOME/.bash_login
$HOME/.profile
~/.bash_logout
/tmp
/dev/shm
/etc/passwd

ps -ef看没用的进程
netstat -anplt 看没用的目标IP
看服务器支持什么开发语言，有什么应用，找应用对应数据目录下的脚本（尤其是用户上传目录和头像等目录）；
每个用户默认的家目录，因为他执行rce，只能在自己的家目录生效；
全盘查找elf类型的文件
last, lastlog
grep -i Accepted /var/log/secure
/var/spool/cron/
/etc/cron.hourly
/etc/crontab
find / -ctime 1
/usr/lib/systemd/system
/etc/systemd/system
chkconfig --list

检查/etc/passwd和/etc/shadow文件，是否有可疑用户
检查临时目录/tmp、/vat/tmp、/dev/shm，这些目录权限是1777，容易被上传木马文件
查看自启动的服务
pstree
lsof： 1. 进程使用的文件， 2. 文件被哪个进程使用，3. 使用某个端口的进程， 4. 系统打开的端口
iftop 监控每个socket使用的网络流量
nethogs 监控每个进程使用的网络流量
strings输出文件中可打印的字符
/var/spool/cron/root
/var/spool/cron/crontabs/root
/var/spool/anacron/cron.{daily，weekly，monthly}
/etc/anacrontab
如果有php防止是webshell


其余的杀毒软件，只能用在下线机器上，进行溯源使用：
clamav杀毒引擎、rkhunter、chkrootkit
find -type f -name *.php -exec chmod 444 {} ;
grep -r –include=*.php '[^a-z]eval($_POST' . > grep.txt
grep -r –include=*.php 'file_put_contents(。*$_POST[.*]);' . > grep.txt

后门查找
/etc/passwd
ssh公钥删除没用的
visudo
find / -perm /4000  找所有suid文件
防止ssh软连接，查找无用的开放端口
有可能把sshd等命令已经替换了，都替换成了带有后门的程序了。
有可能把库文件都给替换了；
w
uptime
last
lastlog
lastb
who
strings /usr/bin/.sshd | egrep '[1-9]{1,3}.[1-9]{1,3}.'
1、root的历史命令
histroy
2、打开/home各帐号目录下的.bash_history，查看普通帐号的历史命令
/var/log/secure
/var/log/message
/var/log/yum.log


执行last,lastlog命令，查看最近登录的账户和登录时间，锁定异常账户。
执行grep -i Accepted /var/log/secure命令，查看远程登录成功的IP地址。
执行以下命令，查找计划任务。
/var/spool/cron/
/etc/cron.hourly
/etc/crontab
执行find / -ctime 1通过文件状态最后修改时间来查找木马文件。
检查/etc/passwd和/etc/shadow文件，确认是否有可疑用户。
检查临时目录/tmp、/vat/tmp、/dev/shm下的文件，这些目录权限是1777，容易被上传木马文件。
查看端口对外的服务日志是否存在异常，例如：tomcat、nginx。
执行service --status-all | grep running，查看当前运行的服务中是否存在异常。
执行chkconfig --list | grep :on，查看自启动的服务中是否存在异常。
执行ls -lt /etc/init.d/ | head，查看是否有异常启动脚本

B端技术中心DD & CC弱点统计
重点：这个只是个模板，需要运维认真处理，因为DDos弱点只有运维知道；
目的：让黑客找不到机房核心IP，只能看到外网代理服务器IP；
目的2：找出对外公开暴漏Ip，找到对商户百名单暴漏IP，找到信息泄露IP（通过confluence信息泄露但只有自己人知道）做预案；
作用：把这个表统计出来，我一打一个准，这就是知己知彼的优势；
No.
一、 DD攻击弱点统计
1. DD攻击基于IP和port，被打死没关系，重要的是有丰富的备用线路，并且被打死的能快速恢复；
2. 最易被攻击的就是IP和端口公开对外暴漏的，黑客最优先打这些目标；
1
2
3
4
5
6
7
8
9
二、 CC攻击弱点统计
1. 防CC攻击看的是整体架构，不是单个IP，需要从外网无防御情况加进行高并发测试。能达到100万并发就足够；
2. 最好是把所有域名都打一遍，所有能IP直接访问的也打，最好做不允许IP直接访问；
3. 云主机上也可以部署基本的CC防御功能，虽然没什么用；
4. 所有域名不能暴漏，不然所有域名一起打CC，CC防御根本不起作用都到了核心机房，而核心机房是没CC防御的，就把带宽吃满了；
5. 核心机房的IP不能直接暴漏在外，只能通过对外白名单访问，不然直接被CC打死；因为机房一点CC防御没有，他主要专注高并发处理业务，防御都在机房外层做的；
1
2
3
4
CC攻击弱点整理：
1
2
3
4

下面的继续经验 记录

七点运维架构：
1. client  客户端
2. CDN    CDN防攻击
3. WAF    自己定制waf防御
4. Nginx   机房添加这个的白名单IP，作为机房的代理
5. Firewall   把机房内的F5或lvs的IP映射出来
6. LVS + keepalive  四层代理      
7. Nginx     七层代理，转发接口；
有四层转发，还要有七层转发，因为七层用于反代各个接口，四层就是傻瓜式转发
一般是机房只跑htttp，https在外网跑完，转发进机房都是http
发现webshell处理思路：
1. 找到日志，看哪台机器产生的，把关键字找到，
2. 去到文件里，确认真的被注入webshell，有很多是黑客的扫描日志
3. 立刻删除，去看从哪个接口进来的，根据webshell内容作为关键字全盘搜索，尤其是Java 日志
4. 找所有nginx 日志，找到这个请求接口，用ack命令，比grep 还好用
5. 确定具体的接口，让开发去修改过滤
6. 最后前端要做加签，和js 加密和请求参数加密，后端验签就够了
不出网原则和最小化原则在测试环境就要做，这样再生产才会习惯
任何安全机制，可以先用非强制模式，permissive ，跑出来日志了，二周左右，把正常合法操作都开启允许，其他的都黑名单就行了。
也就是直接全黑名单，但是不知道白名单是谁，就用非强制模式记录就行。比如禁止出网，先用dns记录log，又比如selinux 要限制行为，就开启permissive 模式就行
百万并发就需要linux内核调优，socket缓冲区，文件句柄数，内存池，RPS/RFS SMP等优化也可以达到。千万并发就需要考虑用户态协议dpdk了
全虚拟化形式，每台机器3个虚拟机，2个运行，一个备份，都启用7层，一台物理机坏了也没事，一台虚拟机下线也可以。
切换直接改ip 地址就可以了。
用supervisor 进程停了就立刻起
服务器需要配置不主动出网，开发提出使用的域名和IP，如果统计不出来就用dns日志跑一周，重要服务器同时用bro跑一周，就抓外出的IP即可，尤其在业务稳定器，遇到黑客攻击再跑就晚了
如果iptables要做域名处理的话，就要用iptalbes + ipset + dnsmasq域名方案了。
如果直接填写域名在iptables里面的话，是一次性记录，如果域名的IP改变了，iptalbes不会跟着改变，
如果用ipset + dnsmasq方式的话，每次请求这个域名都会去解析一下IP的，是实时IP
安全无小事并优先处理原则
安全随时协助运维，运维来确保业务稳定为原则
开发安全手册
Waf 
前端加密js 
数据加密，请求参数
App双向加密
后端验签
防sql注入的
防xss 的，html实体编码
没有的，考虑是否实施，为了世界杯安全事件不影响业务

tcp/ip协议就是这么规定的，在任何isp节点，直接可以返回RST给对方，直接阻断访问；GFW就是这么做的。
经过GFW的域名解析请求，他直接阻断，并且返回一个dns解析。这个就dns劫持了。
GFW与国内DNS厂家合作。指定域名，在DNS厂家就做劫持了
RST攻击，模拟一个包，四元组都是明文的，只要把源端口和tcp的序列号爆破就可以了，大概算来10分钟可以模拟一个服务器发rst包给用户，屏蔽用户访问
劫持有可能用户电脑就被远控了，才劫持。ssl证书随机数劫持，
浏览器劫持。
用户端网络中间人劫持。他们大内网用户http中间人，在转成https访问，http的时候就劫持了。
网络间劫持，是https的内容，不能被劫持。就算dns劫持了也打不开
服务器端劫持，主要看前端js是否又被改动

动态链接库木马概述：
1. 定义后查看动态链接库的方式(动态链接库在/usr/lib64)：
echo $PATH
echo $LD_PRELOAD
cat /etc/ld.so.preload
cat   /etc/ld.so.conf
ls /etc/ld.so.conf.d
用starce命令检查下系统命令：strace -f -e trace=file /bin/ls

2. 中动态链接库木马的现象：
使用普通命令得到的结果，和使用busybox的结果不同；
有些命令用stat查看，时间被修改了；
ldd   elf文件名
3. 修复方法：
./busybox lsattr -ia  /etc/ld.so.preload
./busybox chattr -ia  /etc/ld.so.preload
./busybox rm -rf/etc/ld.so.preload /lib/cub3.so
安全人为漏洞
黑掉代码服务器就直接执行代码进行偷钱
黑客首要目的：偷钱和偷数据
次要目的：劫持，破坏，偷代码
应急响应加一条：
通过木马文件找到进程，然后用进程分析更多的木马文件和网络IP；
有的木马是清理不掉的，只能重做。删除后又创建一个
紧急应急后加一条：
修复漏洞，类似弱点不要在被利用，并且将应用隐藏，让黑客找不到入侵点，比如允许vpn的IP来访问
安全防御添加一点： 所有服务器都要有样板机，就是模板机器，方便某些文件被修改了，直接查看md5值就可以了。很多病毒就会去修改系统命令。
只要是在运行的系统，就要有一个模板保存，随时可以启动的，哪怕用ova保存或镜像保存也可以。
升级后的模板要有备份，以便用的时候能随时拿出来用。
如下日志放到日志服务器。
/var/log/message
/var/log/secure
history日志；
安全系统一大原则：
隐藏原则，一切对黑客是隐藏的，只对内公开。做的防御是怕泄露后做的防御
办公室到生产网络安全
服务器做千层防护，黑客黑掉办公电脑就可以轻松远控服务器，在世界杯期间1秒宕机都是千万级损失；
而办公网安全策略是一个工作习惯的过程，越早作越好，不然现在已经在黑客的肉机之下，就等在世界杯期间再爆发。

黑客入侵途径：
1. 运维系统
2. 办公网入侵到机房服务器；
3. web渗透
4. 应用产品的漏洞.比如堡垒机就发数据到厂家，xshell就发数据到黑客电脑，开发框架漏洞，安全产品窃取敏感信息；
5. 人
6. 物理
目的：
1. 即使黑客远控办公电脑也无法破坏生产服务器系统；
快速发现办公电脑被远控：
1. 浏览器出现flash更新就可能是被web入侵或电脑入侵了；
2. 安装第三方工具的插件，然后鼠标被动一下就是被远控了；
3. 主要监控网络行为，因为运维电脑网络行为是已知的，有异常可以做黑名单和排查出来；
4. 这块大部分是内网安全系统才能发现的。我只能做即使被远控，也会将影响讲到最低；
一、 已发生办公室电脑被黑后，影响生产服务器业务；
1. 办公电脑被黑后，下班后没关电脑，黑客远控控制桌面登录服务器，进行木马植入操作；
2. 办公室服务器被黑后，利用办公室ip为白名单IP，渗透web应用的漏洞，从而渗透进入服务器；
3. 个人电脑被黑后，黑客持久化监控，一旦员工利用个人电脑远程办公，黑客进而连接服务器；
4. 办公电脑被黑后，黑客远控为肉机，进而登录confluence，查看所有运维敏感信息；
二、 防御方案：
1. 办公室IP不在作为白名单，只有VPN IP才作为白名单；
2. 堡垒机的所有服务器可以适当做分权管理只有负责人才能管理所有机器；
3. 下班后关机或拔网线；
4. 离开办公电脑后锁屏，防止敏感信息被看见泄露；
5. 发现被内网入侵后，要有应急方案，比如只有一台电脑可以连接服务器，并且此电脑不出外网，只能白名单连接外网；
6. 登录云平台要配置手机二次验证；
7. 运维电脑要单独Vlan，甚至每个组每个人都是要隔离的，别人受影响要不影响到运维电脑，并且运维电脑要有NIDS网络入侵审计；
9. 运维只允许做和工作相关的网络行为，安装软件需要时官网的，非工作软件不允许安装；
8. Confluence敏感信息定期备份并删除，防止黑客窃取利用。比如用户名、密码和IP等信息；
9. 运维工具统一，不能使用破解版Xshell；
10. 办公电脑不明文存放敏感信息和重要数据；
11. 定期手动全盘扫描病毒文件，更新病毒库和打补丁，新下载的所有文件先扫一遍病毒再打开使用；
12. 办公电脑不能接入任何外设，如U盘、带有自启动木马的键盘等；
13. 一切工作的内容和个人的分开，尤其是远程办公人员需注意；
14. 不允许做任何渗透操作，不允许安装渗透工具，不允许无谓的ping操作；
15. 远程运维再非工作时间不允许连接服务器，这样有助于安全事故分析；
16. 堡垒机、ssh和web应用配置超时自动断开。
17. 聊天软件里的敏感信息，发送完后要删除，防止黑客窃取；
18. 办公网服务器禁止主动出网，禁止对外访问；
19. 不打开任何非办公软件，包括word文档、excel表格，里面都包含宏病毒。pdf也是，可以嵌入链接木马；
20. 个人电脑不允许主动input，有需求的开白名单（可防止黑客内网主动渗透）；
21. 浏览器不要保存密码，每次都要手动输入密码；
11. 最理想化是办公网络做进程白名单、应用白名单、IP和域名白名单、端口白名单；
12. 最理想化是办公网做内外网隔离，内网用于所有办公操作，坚决不出网，出网的业务用白名单并且走web网关（类似CCproxy代理），外网用于上网查资料。
13. 最理想化，用虚拟应用系统，员工做的所有操作都有审计，出故障后有迹可循；
14. 最理想化，运维电脑可以单独做成域形式，统一控制系统安全；
15

监控报警系统
1. ssh登录审计，1分钟内登录5次便报警；
2. nginx访问日志，针对白名单才能访问的网站，就对接口做监控，1分钟内5次访问便报警；
3. 比如mysql应用，gitlab，harbor等应用都可以添加nginx的日志报警系统。
4. dns日志统计，发现不是自己的域名，就做威胁检测；
5
做一个限制或策略，绝对不是在只在一个点能做，要思维打开，在每一个点都有可能做，要相信会有更好的。
比如限制出网白名单，在iptables上能做，在网络防火墙上也能做，在上网代理服务器上也能做。做安全思路一定要打开
网络安全模型：ATT&CK、零信任、自适应安全架构
Gartner提出Adaptive Security Architecture（自适应安全架构）、Forrester提出Zero Trust（零信任模型）、MITRE提出ATT&CK（Adversarial Tactics Techniques & Common Knowledge 对抗战术技术和常识）

信息安全十大要素（CIA）（信息安全七经八脉）
1. 保密性（只有有权人才能使用，加密）
2. 完整性（不能被修改和添加）
3. 可用性（随时随地可以用）
4. 可归责性（审计，分权管理）
5. 可控性（监控报警，防止非法使用）
6. 不可否认性（谁做的任何事都有日志记录，二次验证）
7. 隐藏性（对黑客隐藏，并且乱扫扫不到，并且做好默认安全）
8. 访问控制（认证，授权，屏蔽IP，停掉账号，返回错误页面，等手段）
9. 突发事件预案（一定要有预案）
10. 零信任（纵深防御，每层都不信任，都做安全验证）
11. 真实性（确保通信人的身份就是本人，不是黑客所为）
12. 最小化原则；
13. 一切都落地到文件（所有操作全部由表格记录）（指定到个人和时间），要有计划方案，实施方案，进度详情，事故报告，漏洞统计，每日扫描记录，每日巡检记录。
14. 服务器给黑客一台，他也没用；
15. 办公电脑给黑客，他也没用。
16. 账密都给黑客，他也没用。
17. 自己始终有一个0day漏洞；
18
不安全的系统还没有被入侵的原因：
1. 很幸运，没有被盯上
2. 网站没流量，没什么价值
3. 已经被入侵了，但是还不知道而已
Sslstrip可劫持所谓的https，其实是中间人和用户间还是走http而已
做hsts 防止https劫持
x509 双向认证
用户发现劫持解决方案
劫持解决方法：
1. 看nginx日志，看cdn日志，看前端代码是否有改动，用md5查看。
2. 确认前端代码放在哪里，确认是否被修改；
3. 确认前端代码缓存在哪里，直接清空缓存；
4. 看经过几个nginx转发，直接看转发日志（搜索日志里的302跳转域名关键字就行了）；
5. 看经过几个iptables，看是否有iptable的nat配置；
6. 如果是内核或系统库被劫持了，那就直接逐步更换服务器就行了；
7. 如果是单个用户被劫持，那可能是他电脑系统或浏览器被劫持，或电脑被注马了；
8. 如果是一整个区域被劫持，那就是运营商劫持；
9. 如果是全都各地都有劫持的，那就是百度快照劫持，服务器代码被篡改，服务器内网arp劫持等；
10. 如果是CA证书信任劫持，那只能换域名，同时换高级别的证书了。
11. 全站https，尤其是客服系统，防止发给用户的链接被路由器修改。
12. 如果某个域名被劫持了，赶紧换域名就行了；
13. x509双向认证
14. HSTS
15. HttpDNS
16. 手动绑定arp表
17. 如果是通过搜索引擎访问的被劫持那就是百度快照劫持；
18. 如果是一个CDN线路被劫持了，那就是CDN劫持；
19

劫持原理：
1. 只要数据包（请求和响应）经过的路径，都可能被劫持，包括本地，网络，和服务器端。网络可以随意nat到任何透明代理
2. 主要就看数据流逻辑。一个请求都经过那几个点最重要。有的还会经过第三方api接口请求回调域名；

劫持的种类：
1. 浏览器劫持
2. 百度快照劫持
3. 自己的web服务器JS劫持
4. 路由器nat劫持到其他目标server或透明代理
5. 内网中间人arp劫持
6. 运营商DNS劫持
7. Http的sslstrip劫持
8. Iptables的nat劫持；
9. CDN劫持
10. DNS污染
11. nginx被远控做了301劫持
12. wifi劫持掉下载链接，或者直接dns劫持，或者nat到正向代理；
13. GFW劫持
14. 前端代码被修改，劫持（查gitlab和前端代码服务器，尤其是被编译后的前端代码，做一遍md5校验）
15. 加载器劫持（有的网站有域名服务器，用户访问后，会访问域名服务器，来获取域名，这个服务器被劫持了）
16. Xss注入等前端漏洞，导致被劫持；
17. APP劫持，把app包换掉了。
18. CA证书劫持，信任了同域名的其他证书；
小心有的木马只在世界杯期间发作；
做事要有高度，要能看到思路，而不是具体的任务，要看到威胁；
安全不是运维思维，不是一直平稳的工作
防止一些木马或病毒，在世界杯期间定期执行删除任务，尤其是持久化隐藏rootkit后门
message/secure/dmesg/cron/yum/btmp日志得有保存2年的配置，默认只保存一个月。
ssl证书，安全要求不能用中国的根证书，因为中国可以伪造。买国外的就行，没有利益关系，她不会去伪造。免费的都是中国的
建议读者先阅读一下笔者之前的文章《一文看懂ATT&CK框架以及使用场景实例》和《细述MITRE ATT＆CK框架的实施和使用方式》，对ATT&CK框架的概念、使用场景、以及实施和使用方式先有一个初步的了解，这更有利于理解文本的内容涵义
集中化安全告警平台
洛克希德·马丁网络Kill Chain
防止横向移动就是要划分子网；
防火墙/交换机/终端都配置
我们今天先直接把结论抛出来，一条TCP连接如果不发送数据的话，消耗内存是3.3K左右。如果有数据发送，需要为每条TCP分配发送缓存区，大小受你的参数net.ipv4.tcp_wmem配置影响，默认情况下最小是4K。如果发送结束，缓存区消耗的内存会被回收详细的分析过程敬请期待接下来的另一篇文章
TCP连接的客户端机：每一个ip可建立的TCP连接理论受限于ip_local_port_range参数，也受限于65535。但可以通过配置多ip的方式来加大自己的建立连接的能力。
TCP连接的服务器机：每一个监听的端口虽然理论值很大，但这个数字没有实际意义。最大并发数取决你的内存大小，每一条静止状态的TCP连接大约需要吃3.3k的内存。
最大打开文件数
配置长链接，短连接
监控进程的proc 下面的socket就行了
Nexus为重要服务器，maven也是
一个人一个vpn可以做身份识别，ip 就代表那个人
体育平台--禁止主动出网安全策略需求对接

一、 概述：
通过上周讨论出上百个应用和出网域名，达不到安全防御的目的，今天根据不出网安全策略原则，整理出最终的应用和域名；

二、 服务器不出网安全策略原则：
1. 只做主动出网的限制，内网间互访不限制，外网访问的响应不做限制。
2. 访问域名为动态的（不确定的，或根据回调才能确定的），做允许应用出网，比如jenkins，Marvin和nexus；（基于源IP出网策略）
3. 访问域名为固定的，比如第三方域名或外网固定IP，做允许域名出网；（基于目标IP出网策略）

三、 今天确认事项：
1. 开发：精简出网应用和白名单域名（IP）
2. 运维：通过应用确认IP
3. 运维：确认运维应用白名单，比如ntp服务器，mango报警域名，DNS服务器，异地灾备公网IP，安骑士6个IP等等（运维需要统计）；
4. 可以在隔离预发布环境测试一遍；

四、 下一步操作：
1. 建议在隔离预发布环境测试一遍，然后8月15日应用到生产环境；
2. 协调网络同事做域名和IP的状态检测防火墙策略，只限制主动出网，放行响应请求的出网。并且做到基于源IP的策略和基于目标IP的策略；

五、 重点：
这是非常大的动作，需要各个负责人确认清楚，并且操作后充分测试。如果少了一个出网IP就会影响到业务访问；

六、 总结
咱们大家一起配合，争取零影响地把安全策略实施完成。一起为世界杯做准备；

七、 需要确认事宜：1. 发版时间需要确认

渗透的论坛最好的是90sec和t00ls
体育不出网策略注意：
1. K8s里有Jenkins 就固定宿主机ip 
2. 业务组的9个应用，也固定宿主机ip ，并且pod飘移仅限制在这里台宿主机内。几乎是2-3台宿主机，也就是3个ip 给到网工。
3. Service固定宿主机，配置ingress，修改service配置
安全要做事件被修改报警，因为修改时间可以修改文件change time。这是修改change time的唯一方法。所以要监控时间是否被修改。这个change time可以判断出文件是否被篡改
给代码加个功能的方式：
1. 直接开发改代码；
2. 加探针，用java的agent的方式。也就是改java编译后的代码；
3. 服务器提供接口，让别人调用，就起到了报警的作用；
4. 服务器把写一个接口，对接小飞机等app，一有报警就推过去
linux的Ctime只能和系统时间同步，如果系统时间不改，他只能不断增长，不能使用更早的时间，所以就知道文件什么时候放上来的
以后记住，经验，系统盘不要做lvm分区，就用普通分区，数据盘在做lvm 方便冗余扩展，因为系统盘有时候需要挂在到其他机器，lvm 分区的话，挂不了，就比如pam_unix.so被篡改，登录不了系统了。或者忘记密码了
安全经验：
以后把自己的IP给商户加白，不要把机房IP发出去，就拿一台云主机IP或高防IP做反带发过去就好
也就是对外的IP，一定不是自己机房IP，都要有一个外网云主机，出入都可以用外网云主机做代理；
Nginx 加个密码，web有未授权访问漏洞，就用nginx做访问验证，鉴权还是在web服务器上尽量做
运维的vpn 要做出网限制，只允许工作网站，黑客的网站不允许访问，这就是白名单机制
搭建一个代码审计系统，Pom 用的第三方库和个人库太多了，很多有黑客注入木马的，称为水坑攻击，都不是官方的。poi库我就遇到一次
看漏洞库的几点：
1. 及时
2. 描述信息全面
3. 漏洞多，全面
4. 准确性
黑客攻击途径：
1. URL网址直接渗透，或旁站渗透；
2. 互联网狂扫，扫到什么算什么；
3. 先入侵办公内网在入侵机房网络，或先入侵远程办公电脑；
4. 水坑攻击：运营商、服务提供商，下载站，pom代码提供商，路由器服务商，软件提供商，键盘、usb、xshell提供商
5. 内应：透漏所有敏感信息，直接攻击弱点，并无法溯源；
6. 有白名单的厂家，比如安骑士、dns、ntp、和应用程式需使用的第三方厂家（支付、监控）都是咱们白名单ip。可以更好实施攻击。
7. 云平台账号
8. CDN厂家，就劫持和利用白名单渗透；
9. 物理攻击：直接进机房或办公室，办公室WiFi用玩具直升机渗透。badusb、键盘等等。
10. 其他：云服务器、防火墙、自建CDN服务器等等
四、 安全岗位职责
安全没有百分百，就是看你能接受多少。用规范和技术来做安全。越是安全越是麻烦，就看业务技术是否能接受；
常规安全工作：
1. 漏洞管理
2. 安全规范编制和培训及实施
3. 入侵检测
4. 应急响应
高级安全工作：
5. 溯源
6. 病毒分析
7. 弱点与漏洞挖掘
Linux下的mimikatz：mimipenguin，从内存抓取密码
防内鬼的方法：
职责分离、双人审计，DLP系统
Hids和Nids结合产品，而且是开源的：AgentSmith-HIDS
应急响应手法：
1. 打补丁
2. 限制出外网。或者直接hosts文件才能访问；
3. 限制网络入口，停掉对外应用；
4. 加一个代理，禁止直接出入网；
5. 删除木马文件和进程；
6. 通过网络活动，定位黑客IP；
7. 根据日志，看对方指纹，删除木马内容，维持业务持续稳定；
8. 通过最近使用文件（find / -ctime -2），新增文件，被修改日期的文件，来分析木马文件；
9. 检查源码改动，来分析入侵；
10. 通过nginx日志的UA和关键字“awvs/burpsuite/w3af/nessus/openvas”和api接口，来查找有效payload的http包；
11. md5sum对文件完整性分析；
12. 分析进程，异常进程进行杀死；
13. dump系统内存从而进行分析（高级）
14. Linux常见木马类型进行查找；
15. 看dns里是否有恶意域名
16. 查看最近建立的网络链接，就有可能是黑客链接；
17. RDP、ssh等端口不对外暴漏；
18. last看登录记录及IP，lastb用户错误登录列表；
19. /var/log/secure 记录登入系统存取数据的文件，例如 pop3/ssh/telnet/ftp 等都会被记录。
20. /var/log/cron 与定时任务相关的日志信息
21. /etc/passwd 用户列表
22. /etc/init.d/ 开机启动项
23. /tmp 临时目录
24. ~/.ssh看免密登录的权限
25. /etc/sudoers 查看能sudo用户列表
26. crontab -l和/etc/crond* 看定时任务；
27. Chkrootkit&Rkhunter扫一下
28. 看history和message文件是否在，就知道是否被入侵了。
29. 十二小时内被修改的jsp文件：find ./ -mtime 0 -name "*.jsp"
30. 查找特殊权限的文件：查找777的权限的文件 find / *.jsp -perm 4777
31. 查看所有隐藏文件；
32. 查看隐藏进程的方法：
ps -ef | awk '{print}' | sort -n | uniq >1
ls /proc | sort -n |uniq >2
diff 1 2
33. 系统信息查看：
history (cat /root/.bash_history)
/etc/passwd
crontab  /etc/cron*
rc.local  /etc/init.d chkconfig
last
$PATH
strings
34. 分析sshd 文件，是否包括IP信息strings /usr/bin/.sshd | egrep '[1-9]{1,3}.[1-9]{1,3}.'
35. 效验所有rpm软件包：./rpm -Va > rpm.log
36. 用威胁情报查看ip和文件等信息；BAE Systems Applied Intelligence、Booz Allen、RSA、IBM、McAfee、赛门铁克、FireEye
微步威胁平台：https://x.threatbook.cn/
奇安信威胁情报中心： https://ti.qianxin.com/
360威胁情报中心 ： https://ti.360.cn/#/homepage
绿盟 威胁情报中心：https://nti.nsfocus.com/
VenusEye威胁情报中心：https://www.venuseye.com.cn/
安恒威胁情报中心 ：https://ti.dbappsecurity.com.cn/
360网络安全研究：http://netlab.360.com/
AlienVault : https://otx.alienvault.com/
ISC SANS威胁检测： https://isc.sans.edu/
RedQueen安全智能服务平台：https://redqueen.tj-un.com/IntelHome.html
IBM情报中心：https://exchange.xforce.ibmcloud.com/
37. 新的进程启动后，就发起报警；
38. 利用inotify监控文件系统的变化，尤其是重要目录下面多了一个文件；
39. rootkit列表，用ossec的文件列表：/var/ossec/etc/shared/rootkit_fikes.txt
40. 用inotify实施监控/proc下面的文件变动，实时监控进程启动和结束，并获取相关信息，从而抓住木马信息。
41. 把IP和域名隐藏，只允许白名单访问；
adit日志审计的作用
查看文件访问
监控系统调用
记录用户指令的cmd指令
记录系统安全事件，如入侵行为
监控网络访问
Grsecurity是一组内核修补程序，解决掉所有内核漏洞
监视和搜集所有用户行为信息：psacct
研究两个需求：
1. 某一个进程可以随意访问网络，其他进程不能随意访问网络。这个进程白名单可以随意启停；
2. 进程白名单，不能随意启动新的进程
3. 实时抓取新的进程，及时隐藏进程也能抓取到，实时抓取主动发起的网络行为和系统调用，这样一有远控，就绝对抓得到。最终通过网络层绝对抓得到
apparmor可以限制进程的网络访问
linux lsm实现进程白名单
限制服务器维护时间，Linux的系统调用接口，这些都要被audit审计记录下来，一旦在非维护窗口用到了就报警
入侵检测原理：
1. 基于日志（Audit日志为主，监控系统调用，网络访问，新建进程，隐藏进程）
2. 威胁情报（根据IP，文件，隐藏的文件，隐藏进程，suid文件）
3. 文件完整性
4. 命令审计，进程做的所有操作通过安全库进行判断；
5. 病毒木马库（后门、Rootkit、病毒木马等）；
其他属于安全配置部分：
1. 基线检测
2. 安全架构；
3. 禁止主动出网；
4. 规范守则；
5. 合规检测；
6. 机器可以随时重做系统；
7. 网络配置，最小化原则；
8. 规定时间才可以登录服务器；其余时间都是属于安全报警；
9. 上网服务器都走代理，其余都判断为木马行为，就检测到入侵了。
10. 重点服务器都保护好；
11. 登录服务器行为规范，比如先用VPN在登录，vpn需要二次验证；
安全就四大模块：
1. 做好安全配置；
2. 做入侵检测；
3. 紧急应急和溯源；
4. 漏洞管理；
一、 如下属于高级安全岗位：
5. 渗透测试；
6. 木马病毒分析；
二、 内功：
黑客经验
Windows 防火墙，只允许vpn服务器来链接3389
查看windows 开放的端口，查看windows 漏洞，打补丁
制作Windows系统安全策略；
3389改端口，只允许百名单IP登录，常见漏洞打补丁，关闭不用的服务；防火墙一台一台配置一下
做安全的要保证所有软件必须是官方下载下来的，不能随便下载，现在太多的钓鱼网站的工具了
远程访问docker和k8s的api，要使用认证功能，才可以访问，不然大家都可以随意访问了。至少也要加一个白名单
每台电脑要做网络孤岛，不允许别人访问。只允许vpn的IP访问3389，供工作需求即可
安全做一个重点：
想Jenkins不能做出网限制的服务器，就做入网限制，只有白名单IP可以入网，也就是只有vpn的IP才能访问Jenkins服务，而且做局域网限制，只有防火墙才能访问，其他不能访问Jenkins。防止黑客做内网横向；出网虽然做不了，但是可以做到端口级，也就是80、443随意出，其他端口不能随意出网。
并且进程权限做到最小，不能是root启动进程。普通用户启动这个进程
注入防御的核心原理是不执行，就行了，很多web漏洞都防不胜防，直接就让客户端提交的参数不执行就行了；
访问所有服务器包括云主机和堡垒机都不允许办公室IP直接访问。只能通过vpn的IP为白名单访问。最好再加一个堡垒机
Rootkit解决方法，升级内核到最新，因为每个内核代码都是根据内核版本而定的，升级内核rootkit代码自然不生效了
要有情报威胁系统，
比如在防火墙上，记录了4元组，对每个目标ip 都进行情报威胁的检测，对每一个传输的文件都抓取，也进行情报威胁检测，就可以做入侵检测了
Rootkit查不出来的原因是，他在内存里，并且是内存的内核区，普通进程都运行在用户态，所以普通杀软都无法查杀内核态区域，就查不出来了
虽然Linux 一切皆文件，但内存里就有内核态与用户态的区别了，高权限的操作，全部是内核态完成的，内核态需要写内核模块，不是普通程序，也不是调系统调用，而是调内核函数，完全不一样的。总之内核态程序就是写内核模块
体育目前还有遗留漏洞
1. 容器逃逸漏洞
2. 进程有root权限
3. 防火墙只放行80和443出，其余不能出
4. 容器内反弹shell 无法检测
我们可以使用专业的扫描工具来确保安全，比如 NodeJS 的 npm audit , GitHub 的 Dependabot;至于我们的业务代码，可以使用其他的一些安全工具可以扫描，比如 SoneQube
容器和镜像安全扫描
可以购买腾讯云容器安全服务，tcss
容器安全扫描工具对比
针对上述解决方案，我们调查了 Trivy、Claire、Anchore Engine、Quay、Docker hub 和 GCR 等几种扫描工具，从不同维度进行对比
使用阿里云容器镜像仓库acr 服务，来做所有景象批量检测
卸载容器里反弹shell 命令，包括nc
因为bash通过web执行会不成功，所以都会用其他工具。
也可以把bash换成其他shell，黑客不知道就行。如果必须有指定shell就这么干
Vulhub是漏洞靶机平台
想办法让k8s没有shell ，所以就无法反弹shell 。只要不远控，就不是作为层面的责任，都是代码层的责任
Vulhub是漏洞靶机平台
K8s还能出网需要做的安全策略：
1. 容器的权限以非root启动，并且内核升级到最新，无法做提权和逃逸就可以了；
K8s的容器不能以root启动，不然权限太大，防止被远控
查看所有内核模块，把没用的内核模块都去掉，只保留有用的
一定要有个密钥管理服务器，类似配置中心，所有配置文件从密钥服务器读取密钥。
主要是密钥不能写在配置文件里面。
不能把密钥写死在本地，太危险了。不易管理，离职频繁。
所有密钥不保存在本地，只在密钥管理服务器上保存一份，谁都不知道，只有创建的人知道而已
登录所有服务器不要配置免密登录，这样就方便于黑客了。就要有密码和二次验证登录。
密钥管理用zinaer系统。阿里云也有KMS系统
防止容器被反弹shell，这样做：
1. 在容器内：chmod -x /bin/bash
2. 如果容器需要shell，就这样恢复：
docker exec -it 1cf9cb8ee2f4 chmod +x /bin/bash
docker exec -it 1cf9cb8ee2f4 /bin/bash
一定要有个密钥管理服务器，类似配置中心，所有配置文件从密钥服务器读取密钥。
主要是密钥不能写在配置文件里面。
不能把密钥写死在本地，太危险了。不易管理，离职频繁。
所有密钥不保存在本地，只在密钥管理服务器上保存一份，谁都不知道，只有创建的人知道而已
登录所有服务器不要配置免密登录，这样就方便于黑客了。就要有密码和二次验证登录。
密钥管理用zinaer系统。阿里云也有KMS系统
黑客远控木马的几个途径：
通过web接口上传木马，然后用命令直接漏洞去执行木马
黑客通过web接口上传木马，然后用web网址，直接执行；
直接命令执行漏洞，下载并执行木马；
先反弹shell，在运行木马；
先webshell，在运行木马；
通过ssh爆破，在执行木马；
通过已有后门，在运行木马；
内应直接上传木马和执行木马；
容器去掉如下命令：Lrzsx ，，sh, tmux,,/etc/shells下面的命令，bash, curl, wget,命令全部取消。telnet, nc, ping
setfacl可以配置某个命令的权限，某个命令只给某个用户，这样甚至root都没有权限；
enable可以禁用Linux的内置命令；
Cyber Kobe, [2022/9/11 16:13]
黑客执行木马的途径：
1. 直接命令执行漏洞，下载并执行木马；
2. 先反弹shell，在运行木马；
3. 先webshell，在运行木马；
4. 通过ssh爆破，在执行木马；
5. 通过已有后门，在运行木马；
6. 内应直接上传木马，在执行木马；
7. 利用未授权漏洞，登陆系统，然后利用系统功能执行命令；

Cyber Kobe, [2022/9/11 18:05]
40日安全工作计划：
1. 找DDos攻击弱点，防止IP泄露的方法；
2. 高防机房；
3. K8s能出网机器的安全；
4. 机房能出网服务器和网络设备的安全；
5. K8s和Docker安全；
6. VPN，堡垒机等重点服务器安全加固，并手动检测一遍；
7. 办公室到生产服务器安全加固；
8. 所有云平台子账号开启二次验证，用谷歌验证码；
9. windows电脑做入侵防御，防止内网横向入侵。
10. 高防机房，及攻击测试，编写CC脚本比较花时间；
11. 整理防火墙策略，把对外公开的IP和端口都统计出来，和随意出网的IP都统计出来，做一个全面整理，找漏洞点；
12. 把安骑士不好用的机器统计出来，把所有能出网的服务器统计出来，做到心中有数，
13. 重要服务器高级系统防御策略，得做一份出来（Jenkins只允许白名单Ip访问）。给没有安骑士和重要服务器准备的；
14. 搭建一套蜜罐系统；
15. 基线检测需要全面扫描并清理一遍；
16. history日志加上时间，考虑搭建日志服务器，避免黑客清理痕迹；
如下日志放到日志服务器。
/var/log/message
/var/log/secure
history日志；
message/secure/dmesg/cron/yum/btmp日志得有保存2年的配置，默认只保存一个月。
17. 4.2通过VPN访问堡垒机：所有机房服务器、Kubernetes、机房物理机、数据库；
4.3通过VPN访问运维管理平台：Jenkins、Confluence、Gitlab、虚拟化、监控；
18. 台湾机房所有公开爆露在外的IP和端口扫描一遍；禁止公开爆露在外；
19. 生产环境和其他所有环境进行网络隔离，办公电脑做网络孤岛配置；
20. 容器禁用rm和crontab和mkfs命令，做容器逃逸加固配置；禁止ping（因为有ping隧道），禁止有脚本环境，禁止免密登录，
21. 容器安全扫描系统，重点对镜像执行安全扫描，这个可能得花钱；
22. 用户上传目录一定要配置默认上传文件后的权限为644，不能用执行权限；
23. docker进程的权限，最好不要以root启动；并且dockerfile里面指定的user，不要是root。
24. 所有机器内核更新到最新，防止被注入的勒索型rootkit在世界杯期间自动爆发。
25. 服务器可以做一遍离线后的深度查杀，使用付费版杀软；
26. 系统补丁和内核补丁，全部打一遍；
27. 云主机配置安全组，只开放需要的端口；
28. 统计所有反弹shell命令，并在系统删除掉：
29. 做ssh登录日志监控报警；还有su和sudo日志监控，iptables上配置只允许堡垒机和跳板机和Jenkins去ssh；最好所有登录日志都做；
30. 下班后必须关机和拔网线；远程应急响应的可以让同事帮忙开机；
31. 我的电脑会做内外网隔离，访问外网只有一个云主机，办公电脑只允许白名单对外访问，这样中了木马也不会被远控，另外做网路孤岛，谁的电脑被黑了也无法横向入侵到我；
32. 制作木马，手动测试安骑士是否快速触发报警；
33. 不能安装安骑士的就用其他安全软件先代替，
34. 主机上的sshkey，无用的都清除
35. VPN最好加上出网IP白名单，只允许机房的IP和堡垒机IP，其余都不允许访问；
36. 用apparmor做进程的网络访问限制，只允许docker出网，不允许其他进程出网，就解决了服务器被远控的问题了；
37. 做一个Jenkins的安全配置：想Jenkins不能做出网限制的服务器，就做入网限制，只有白名单IP可以入网，也就是只有vpn的IP才能访问Jenkins服务，而且做局域网限制，只有防火墙才能访问，其他不能访问Jenkins。防止黑客做内网横向；出网虽然做不了，但是可以做到端口级，也就是80、443随意出，其他端口不能随意出网。
并且进程权限做到最小，不能是root启动进程。普通用户启动这个进程
38. 体育目前还有遗留漏洞
1. 容器逃逸漏洞
2. 进程有root权限
3. 防火墙只放行80和443出，其余不能出
4. 容器内反弹shell 无法检测
39. 把容器的/bin/bash和/bin/sh和/bin/tumx都去掉执行权限，用的时候在添加。
Lrzsx ，，sh, tmux,,/etc/shells下面的命令，bash, curl, wget,命令全部取消。telnet, nc, ping
/bin/tcsh
/bin/csh
awk
gawk
exec
mkfifo
msfvenom
禁止yum和apt和apt-get,用setfacl或取消x权限；
perl
python
nodejs
php
ruby
lua
ncat
openssl
/usr/bin/tclsh
xterm
ksh
ash


防止容器被反弹shell，这样做：
1. 在容器内：chmod -x /bin/bash
2. 如果容器需要shell，就这样恢复：
docker exec -it 1cf9cb8ee2f4 chmod +x /bin/bash
docker exec -it 1cf9cb8ee2f4 /bin/bash
40. 一定要有个密钥管理服务器，类似配置中心，所有配置文件从密钥服务器读取密钥。
主要是密钥不能写在配置文件里面。
不能把密钥写死在本地，太危险了。不易管理，离职频繁。
所有密钥不保存在本地，只在密钥管理服务器上保存一份，谁都不知道，只有创建的人知道而已
41. 容器逃逸漏洞。
42

每日任务：
1. 漏洞管理；
2. 所有堡垒机巡检；
3. 云平台子账号管理；
4. 安骑士巡检和互联网威胁报告查看；
5

不急于做的工作：
1. 所有云账号所属厂家统计；
2. 所有云账号，定时修改密码和验证邮箱有效性；
3
两个神级的入侵检测方式

有一个方法，只要有命令执行漏洞，就可以获得对方机房出口IP，然后直接打死。
1. 有命令执行，就让他请求我的机器，然后我tcpdump抓包；
2. 就算不能出网，也可以dns解析，如果他的dns服务器在机房就知道他的机房出口IP，直接打死，所以最好机房内一个dns缓存，然后机房外一台dns解析服务器；
3. 出网都走代理，这个代理单独一条线，被打死了不影响业务就行

只要有RCE漏洞，就无法防止黑客知道核心IP，解决方法就是：
把这条线路做高防
如果用上网代理服务器，那就最好放在外网，如果在内网，那就把核心IP给暴漏了。
在外网，几乎认为代理服务器为无漏洞，所以不用怕被入侵，只担心被攻击；
IPset的全球IP CIDR地址集
代理服务器有3种：
代理服务器都是：ss-server，squid,tproxy，redsocks；
就代理客户端分如下几种：
1. 反代
2. 正向代理（默认的代理），ss-local
3. 透明代理（用户不需要配置，直接就是用的代理就是透明了）
比如路由器安装一个透明代理软件，数据包一经过，就执行代理程序，转发走了；软路由程序：openwrt GUI
比如服务器上安装一个透明代理，然后配置iptables的nat的redirect转发给透明代理，再通过透明代理上网即可；软件程序如：clash、ss-redir
透明代理就是正向代理，只不过他不被用户感知，所以就单独划分出来了。它本身就是正向代理
信息安全标准： 27000
信息安全中级目标：
1. 业务不能停，数据不能丢
2. 钱不能丢，流量不能丢
网络安全2.0：
1. 数据驱动安全
2. 安全异常深度检测
3. 安全风险事件精准预测
4. 态势感知
Linux后门隐藏总结：
1. 文件隐藏
2. 文件时间隐藏
3. 文件权限隐藏，chattr，让root无法执行。只能直接编辑，ls和find都无法查找；
4. 历史命令隐藏
5. SSH登录隐藏，只能ssh白名单；
6. 端口隐藏，端口复用
7. 进程隐藏，进程注入，进程复用
机房对接第三方出网的代理IP方案：
1. 正常是机房服务器直接出网到第三方服务器；
2. 为了避免机房核心IP不爆露，不然被打死没办法。
3. 机房出网走一个代理IP，走两层，机房内部一层(F5)，云主机一层(goproxy)
4. 代码层配置使用usesystemproperties, 
5. 程序jvm上配置代理服务器，指向机房f5. 
6. 在F5上配置云主机负载均衡，这样云主机即使出故障也能快速切换，在F5上切换就行了；
7. 这样暴漏的Ip只有云主机，可以随时切换；
8. 一个项目一组代理服务器，出问题互不影响，也知道是哪个项目出外问题，然后定位解决问题
9. 外网云主机可以用一下高防，因为是多台，用高仿的那台可以是机房高防，但是不能是用清洗中心的高防，不然太慢了。
10. 整套代理系统最后有一条默认出口，那就是走机房出口，如果所有代理都死了就走机房出口，不至于业务停掉；
各公司DDos弱点总结：
当前IP分高防CDN、云主机自建反代、核心机房IP、自建机房；
1.1. 高防CDN被打死了就更换CDN，进行硬抗；人为切换；
1.2. 自建反代被打死了就手动切换；
1.3. 核心机房IP被打了，几乎没办法。只能设置IP黑洞后手动三个IP互换。建议每个业务增加新的备用IP，防止现有IP全部泄露；
1.4. 自建高防机房被攻击不怕，会去欧美进行清洗。
1. 机房所有IP只要暴漏，一打就死，毫无办法，最多3个IP互相切换，但都是没有防御的3个IP；
2. 机房IP泄露途径：
2.1 confluence，或本地文件泄露；
2.2 所有运维和网工都知道，他们工作需要（可以有独立的cdn团队-菲律宾人团队）；
2.3 在服务器上查外网IP即可，curl ipconfig.co
2.4 和第三方对接，暴漏出去（出第三方和入第三方都没有代理）；
2.5 如果程序有RCE漏洞，黑客可以直接执行ping命令获取机房IP；
2.6 机房IP对外开放没有白名单，允许外网扫描；
2.7 域名直接解析到机房IP，没经过nginx反代；
2.8 云主机被入侵或云账号泄露，机房核心IP就暴漏了。因为upstream配置在云主机上；
2.9 核心机房的IP直接暴漏给cdn的upstream配置，没经过自己的nginx反代；
2.10 黑客通过一个IP，从而找到IP段，最后找到ASN里所有IP。
2.11 所有运维应用直接访问机房IP，包括堡垒机，Jenkins，yarning，confluence，gitlab等；
2.12
3. 即使核心IP隐藏了，那么代理IP暴漏了也会被打死那就有如下防御方法：
3.1 用高防IP，不走全球清洗中心那种，只用机房高防设备。
3.2 自己准备多个代理服务器，做负载均衡；
3.3 做二层代理，这样随时可以修改，不用开发改代码，也不用重启；
3.4 一个项目一组代理服务器，出问题互不影响，也知道是哪个项目出外问题，然后定位解决问题；
3.5 二层高防的多台机器用一层代理来做负载均衡。并且采用高防服务器。
3.6 整套代理系统最后有一条默认出口，那就是走机房出口，如果所有代理都死了就走机房出口，不至于业务停掉；
4. 4. 接下来，各组负责人告诉我你们的架构，我来找单点故障或者ddos弱点；然后做防御加固
高防机房一个知识点：
1. 一个ip被打了，那么这个IP段都送到清洗中心去清洗，但是属于ASN的其他ip段不变。
2. 所以，分配IP的时候，一个IP段为一个业务，被打后不要影响其他业务。
3. 划分IP的时候一定要考虑，一个IP段被打了是整个IP段送去欧美清洗，别影响用户体验；
计算机发展简史：
1. 1970 计算机成型；
2. 1980 网络成型；
3. 1990 全球爆发式增长；
4. 2000 中国也发展计算机互联网；
5. 2010 计算机及网络技术稳定完成
所有应用都有访问控制系统，包括云账号，堡垒机，后端程序等。
他就是基于角色的赋予权限，RBAC，基于角色的访问控制，有的角色有权限就能访问，有的角色无权限就不能访问；
安全三要素：CIA及破坏途径：
机密性：防止未授权访问：窃取密码文件，社会工程学，网络嗅探
完整性：防止未授权修改数据：校验数据，病毒，劫持，程序漏洞
可用性：已授权用户不间断访问数据：设备故障，软件错误，物理故障，人为错误，安全策略配置错误
入侵检测系统评价指标：
可靠性，指系统的容错能力和可持续运行能力；
可用性，指系统开销大小，对网络性能影响的大小；
可测试，指系统能够通过模拟攻击进行检测测试；
适应性，指系统易于开发和扩展；
实时性，指系统能够及早发现入侵企图；
安全性，指系统可确保自身的安全；
准确性，指系统正确识别入侵行为的能力
入侵检测原理：
1. 系统或网络的日志文件
2. 网络流量
3. 系统目录和文件的变化
4. 程序执行行为
重要服务器安全加固：
重要服务器定义：
1. 集权服务器，一旦被黑客入侵，就所有服务器沦陷了；
2. 生产机房没有安骑士的机器，但是很重要的机器；
3. 重要机器，一旦宕机就影响业务稳定性；
4. 还能出网的服务器；
5. 没有安全软件的服务器，安装不了安骑士的服务器；
重要服务器安全加固策略：
1. 服务器里面的应用只能白名单登录（ssh和应用）；
2. iptables做INPUT内网访问白名单，OUTPUT做最小化，精确到IP和port；
3. 网络防火墙上做外网访问白名单，和出网限制；
4. 应用升级到最新；
5. 安装文件MD5完整性检测软件；
6. 禁止Docker执行bash，去掉/bin/bash权限；
7. 应用程序以普通用户启动；
8. 内核升级到最新；
9. 删除不必要的命令和脚本语言环境；
10. 在前端挂一个云WAF
11. 使用OpenSnitch，做基于应用的防火墙规则；
12. 做完代理出网后，把直接出网策略取消掉，只允许通过代理出网；
13. 用fail2ban小程序，监控nginx日志和ssh日志，过多404页面就直接联动iptables屏蔽IP；
13. 挂接CreateProcessW，判断里面的命令，如果是禁止的程序，直接return FALSE;即可。HOOK再底层一点的:zwCreateProcess
13. 用enable删除指定的内建命令，用chmod -x取消外置命令；
13. 直接删除系统的C环境和C库，或者把系统C库改个名字，所有木马都得用C库，java是虚拟机不用系统库。这样所有木马都无法运行了还不影响应用；
前置条件：ll  /lib64/libc.so.6
策略：mv /lib64/libc.so.6-bak /lib64/libc.so.6
恢复：LD_PRELOAD=/lib64/libc-2.28.so ln -s /lib64/libc-2.28.so/lib64/libc.so.6
13. Goproxy的web管理页面只允许VPN白名单IP访问，并且修改默认端口，复杂密码；
13. 用apparmor来做禁止java进程调用bash和csh等远控文件，这个看木马的原理怎么写的。
14. 执行一个python脚本，不允许新建进程，也就是普通木马文件无法执行。
15. 用Apparmor，只允许java进程和docker进程使用网络，其他程序完全不能使用网络；
把黑客常用的命令都禁止出网，只允许java出网；
//限制其在对家目录下几个文件的读写权限
deny @{HOME}/.bash* rw,
deny @{HOME}/.cshrc rw,
deny @{HOME}/.profile rw,
deny @{HOME}/.ssh/* rw,
deny @{HOME}/.zshrc rw,
//对以下文件具有读、写、或可执行的权限
/etc/X11/cursors/oxy-white.theme r,
/etc/default/apport r,
/etc/kde4/* r,
/etc/kde4rc r,
/etc/kderc r,
/etc/security/* r,
/etc/ssl/certs/* r,
owner /home/*/ r,
/opt/firefox/firefox.sh Px,
/usr/bin/convert rix,
/usr/bin/kde4 rix,
/usr/bin/kopete r,
/usr/bin/kopete_latexconvert.sh rix,
/usr/bin/launchpad-integration ix,
/usr/bin/xdg-open mrix,
/usr/lib/firefox*/firefox.sh Px,
/usr/lib/kde4/**.so mr,
/usr/lib/kde4/libexec/drkonqi ix,
/usr/share/emoticons/ r,
/usr/share/emoticons/** r,
/usr/share/enchant/** r,
/usr/share/kde4/** r,
/usr/share/kubuntu-default-settings/** r,
/usr/share/locale-langpack/** r,
/usr/share/myspell/** r,
owner @{HOME}/.config/** rwk,
owner @{HOME}/.kde/** rwlk,
owner @{HOME}/.local/share/mime/** r,
owner @{HOME}/.thumbnails/** rw,
owner @{HOME}/Downloads/ rw,
owner @{HOME}/Downloads/** rw,
}
16. 去掉shell内置执行命令：
unenable eval
unenable exec
command
source
test
. 读取并执行指定文件中的命令（在当前 shell 环境中
caller 返回活动子函数调用的上下文
安全口号：
1. 即使密码给黑客，黑客也无法利用；
2. 即使漏洞给黑客，黑客也无法主机（只能做代码层面入侵）
3. 即使木马给黑客，黑客也无法利用；
4. 即使机器给了黑客，他也无法影响我的业务稳定性
何为难：
1. 知道
2. 理解
3. 应用
复杂点说是：
1. 知道
2. 理解
3. 逻辑步骤多
4. 动手熟练做出来
防木马方法：
直接删除系统的C语言环境和库，所有木马都无法执行了。
把库改个名字也行
学一门语言的过程：
1. 语法
2. 自带方法
3. 扩展库
4. 实现业务
5. 做出常人做不到的实现。利用整合思维和逆向思维和技巧
用apparmor来做禁止java进程调用bash和csh等远控文件，这个看木马的原理怎么写的
总结运维层面影响业务的漏洞及弱点
1. 核心机房ip 暴扣和已报漏
2. 命令执行
3. 反弹shell 
4. 注入木马
5. 代码执行
6. 入侵vpn及堡垒机和Jenkins 等集权服务器
7. 最小化原则，权限最小化
8. 网络行为审计，帮助溯源
9. 日志服务器，防止痕迹清理
10. 无单点故障，被入侵可以随时切换
11. 更多的hids 系统做入侵检测
12. Ip 和端口公开报漏（只有代理服务器可以暴露）
13. 被黑客全球扫描，
13. 供应链攻击，白名单限到端口，只开业务端口，不报漏其他端口
14. 0day漏洞，运维系统对外隐藏
15. 通过办公电脑到机房，做电脑防入侵策略
16. 远程办公人员被远控，云账号二次完整，非工作时间不能连服务器
17. 基本安全配置做一个列表
18. 限制远程运维权限，用的时候开启权限，不用关闭权限
19. 开发只有查日志权限
20. 防止提权，宿主机内核升级
21. 防止遗留木马，在世界杯期间触发，破坏系统
22
重要安全经验记录：
1. 防御0day最好的方法就是隐藏。也就是隐藏端口，域名，IP。
2. 直接禁止公开ping，加白名单就行。这样防止黑客扫描。
3
ELK扫描入侵的原理：
每分钟查询日志，通过ES接口查询一分钟的日志，是否包含关键字或特征码。
其余入侵检测功能是其他模块带的
Wazuh原理
对来源的数据先解析在过滤，符合要求的就报警，符合要求的就存储到es。就是在数据来源的时候就搞定。不要等存储es之后在操作；
找机房核心IP的方法：
1. 黑掉办公电脑后，所有信息都有记录，尤其是xshell；
2. Xshell用的是破解版的，间谍软件专门把这些信息外传；
世界杯需求：
1. 世界杯期间，要有监控团队
2. 要有办公网被打死的预案，办公网比较容易被打死
3. 最好工作时间调整好，根据比赛时间
4. 运维同事电脑的登陆密码再加强，因为你们都需要远程办公；
5. 出安骑士外，需要另外购买Hids产品，腾讯云的是很好的替代品；
6. 更换齐志堡垒机改成Jumpserver，因为漏洞太多，不能升级，功能越多越有漏洞；
7
用网络的span技术，可以把所有二层交换机的流量全部景象到ids上，不仅仅是只有经过核心交换机的流量了
存储虚拟化：
对象存储
文件存储
块存储
数据库透明加密系统
安全重要经验：
1. 要做三权分立，每个人一部分权限，不能把权限放在一个人身上
紧急应急有一个方法：
1. 把应用程序重启，以非root账号启动。即使有漏洞也不怕。
2. 用apparmor做访问控制
数据库加密系统其实是数据库透明加密系统，
数据录入的时候进行加密，然后存储到数据库里。
如果要通过程序读取，解密后返回给用户。
用其他方式读取数据库，都是密文的。
就实现了数据加密。（称为透明加密
访问控制系统：(AAA认证)
单点登录
Openldap
Nac
一个安全工程师的日常习惯：
1. 熟悉整个运维架构和技术点；没有这些做基础我就无法做安全；
2. 出解决方案，先考虑安全角度，最后考虑运维效率；
3. 遇到安全事件我第一时间处理，协调运维处理，我不操作服务器；（其实应该有个监控团队做报警通知）
4. 注重信息安全，所有敏感信息发完互相都删除，所有敏感信息我这里只阐述最终结果，详细细节交给领导决策。因为是多个组。
5. 注重细节，遇到细节我会找你们沟通，找出安全弱点
漏洞原理宝典：
Java比php安全的原因：
因为漏洞会木马都是需要两个条件才能执行：
1. 放到服务器上；
2. 能执行。
php几乎能放到服务器上就都能执行。就不安全。
Java几乎能放到服务器上但不能执行。就安全
世界杯期间容易发生的安全问题：
1. 流量异常，网络运维都怀疑是安全事故，而且服务器无响应，现象和勒索软件一样
2. 服务器安全告警过多，误报和警告会暴增，又不能关机等大动作，只能靠系统配置尽量修复，系统层处理不好就导致业务宕机
3. 世界杯期间运维非常忙，很多操作只能我自己做，我不能有误操作
4. 开发部分的安全一点都没做，世界杯期间肯定爆发，都不知道哪里来的，配合起来需要很久
5. 如果有遗留木马爆发，或者运维配置不完整的地方，世界杯期间一旦发生，就是大动作。尤其是内网肉鸡一直都存在，windows 系统跟容易死机蓝屏，甚至启动不起来。
6. 世界杯期间由于大量的利益驱使，导致所有安全问题集中发生，一个月等于一年。需要提前做好应急预案，和把这几年遇到的安全问题从头到尾熟悉一遍，安全是一个系统工程，不在于某一个点，在于疏忽哪一个点。
7. 高防机房带宽2g，有一个cc攻击点被利用，或某个接口能重放回源，他就是最大的瓶颈，很快就跑满，得提前写cc攻击脚本测试，抓代理做攻击系统，最后还要配合运维和机房做策略。
加一款网络产品：
1. 暴漏资产和指纹检测系统
可以做成互联网大量扫描
企业内网扫描
互联网定向扫描，就扫咱们自己的网站
渗透师
运维安全七要素：
1. 服务器不主动出网
2. 服务进程不用root启动
3. 补丁都打全
4. 白名单，对黑客隐藏。启用内网间防火墙，只开放业务端口；
5. 入侵检测系统（安骑士）
6. 堡垒机系统，对一切输入有审计；
7. 所有登录，必须有二次验证，比如阿里云比如zabbix等；
8. 只开放有用的端口，比如22、80、443



























遇到入侵报警就立刻断网，将风险降到最低，
然后启用临时解决方法，最后做病毒分析和溯源，
以非root启动可以作为临时解决方法
0day解决方案：
1. 以非root启动
2. 访问域名和ip 隐藏
3. 禁止出网
4. 应用程序出网采用代理的方式，用request库的proxy方式
5. 防火墙禁止入网和白名单配置
6. 把bash命令和wget 等命令权限去掉，用的时候再添加。
7
被动入侵手法：
1. 获得密码后，直接连服务器
2. 遗留木马，自己触发了
3. 登陆云平台，操作了服务器
4. 内网中间人信息收集，登录了虚拟化平台，操作服务器
4. 运维电脑被黑，远控服务器
5. 使用有木马的应用程序
6. 中间人劫持
7. 黑客做完免杀，做进程注入，在做端口复用，完全没有痕迹
8. 运维管理服务器被黑后，从而操作其他技术，比如杀软远程安装，Jenkins 远程执行命令
2. 爆破
3. 木马文件执行；
4. 身份欺骗
5. 数据篡改；
6. 信息泄露；
7. 提权；
8. 可否人性；
9. 拒绝服务；
10. 人为泄露信息（内应）
11. 社工库爆破
12. 运营商劫持；
13. 水坑攻击；
14. 供应链攻击；
15. 社会工程学
16. 业务逻辑漏洞
17. 故人干私活，从而把员工电脑给黑了，也就黑了他的公司资料；
18. 获取网盘等信息；
19. 植入前端广告，入flash下载；
20. 网站挂马
21. 发送垃圾邮件、短信等；
22. 入侵路由器，默认安全；
23. 全网批量扫漏洞；
24. 买个被远控的二手电脑，所有服务器都沦陷了；
被动攻击入口            
port\被动攻击 水坑攻击 信息泄露泄露 代码被控制 内网挂马 硬件设备漏洞 第三方/中间人  confluence信息泄露  博客信息泄露













windows服务器使用applocker做应用程序允许运行
linux软件限制策略
applocker原理，
它可以限制应用程序启动
从内核层的做法是：系统对应用程序的监控和限制，
从应用程序层的做法是： 进程注入+钩子程序，最后动态调用防火墙
程序间相互调用的原理：（C/S的原理，生产者/消费者原理）：
一、 调用者：
1. 标准输入，
2. 程序调用
二、 响应者：
1. 标准输出，
2. 标准错误，
3. 程序返回；
进程的种类：
1. 守护进程（服务，Daemon）
2. 前台进程（普通脚本）
3. 后台进程（shell关闭会消失，可提升为Daemon
谷歌云厂家给的安全建议：
1/ 避免於GitHub此類公有代碼庫中，存放與公開您雲端登入密鑰、憑證等機敏資訊
2/ 保護帳號與驗證資訊：對雲端環境的訪問限制給予最小權限，同時搭配MFA或2FA等機置提供多重身份驗證  
3/ 減少GCE、與GKE資源的對外露出非必要端口，並限制外部來源的連線IP
4/ 強化GCE、與GKE資源的安全；如限制SSH登入端口的訪問來源、監控和修補VM映像檔及容器映像檔的漏洞
5/ 檢測異常活動；如GCE與GKE中稽核日誌，管理員登入與IAM權限異動的潛在風險
6/ 避免下載使用未經授權與驗證過的原始碼
7/ 建立災害復原計畫，使用無害的備份檔加速恢復業務
今天把cmd 禁止出网，因为黑客软件都使用cmd 运行
如何防止sql注入?
1. 使用预编译机制
尽量用预编译机制，少用字符串拼接的方式传参，它是sql注入问题的根源。
2. 要对特殊字符转义
有些特殊字符，比如：%作为like语句中的参数时，要对其进行转义处理。
3. 要捕获异常
需要对所有的异常情况进行捕获，切记接口直接返回异常信息，因为有些异常信息中包含了sql信息，包括：库名，表名，字段名等。攻击者拿着这些信息，就能通过sql注入随心所欲的攻击你的数据库了。目前比较主流的做法是，有个专门的网关服务，它统一暴露对外接口。用户请求接口时先经过它，再由它将请求转发给业务服务。这样做的好处是：能统一封装返回数据的返回体，并且如果出现异常，能返回统一的异常信息，隐藏敏感信息。此外还能做限流和权限控制。
4. 使用代码检测工具
使用sqlMap等代码检测工具，它能检测sql注入漏洞。
5. 要有监控
需要对数据库sql的执行情况进行监控，有异常情况，及时邮件或短信提醒。
6. 数据库账号需控制权限
对生产环境的数据库建立单独的账号，只分配DML相关权限，且不能访问系统表。切勿在程序中直接使用管理员账号。
7. 代码review
建立代码review机制，能找出部分隐藏的问题，提升代码质量。
8. 使用其他手段处理
对于不能使用预编译传参时，要么开启druid的filter防火墙，要么自己写代码逻辑过滤掉所有可能的注入关键字。
9. SQL语句过长则不执行；
10. 不要把机密信息直接存放，加密或者hash掉密码和敏感的信息
11
整个系统的接口参数都是经过加密和加签的，这样就防止扫描了
安全是最重要的，不一定什么时候就回到解放前，钱全丢了，客户全丢了。就连服务器和代码都被删除了，网站无法继续正常运行下去。
安全要做好得特别熟悉运维的环境和开发的业务，出了问题才能快速定位漏洞点
数据库要看每条sql语句是哪个用户执行的，什么时候执行的，哪个IP执行的，以及上下文（起因经过结果）怎么黑进来的，干了什么，结果怎样。
数据库安全一定要做，不然一个sql语句改变订单结果，都不知道谁执行的。怎么执行的。随意让黑客修改数据库
人脑比电脑的优势，尤其是人工智能：
1. 创新
2. 想象力
3. 预判
4. 联想
我认为人脑的优势：
1. 操控机器人
2. 创新思维，跳出限制圈
3. 有感情
4. 想象力、联想力
如果有必须出网的服务器，就让他出网，但是千万不能连接数据库，也不能连接其他服务器，就是最小化，先做网络最小化，在做权限最小化。就算被入侵了也是在网络孤岛里
如果k8s的某个服务要出网，那就把它固定在需要出网的服务器组里。容器固定某个node节点，只有几个node节点可出网而已
这样将影响降低到最低
1. 运维的web管理平台都做白名单和二次验证。防止黑客内网横向渗透和工作及被黑后直接登录系统。不然只能认为是运维自己所为。
2. 密码要复杂；
3. 登录服务器要二次验证；
4. 登录个人办公电脑也要二次验证；
5. 不能使用3389，使用teamviewer和anydesk等远程桌面，因为input全部禁止，这些远程桌面不用input。用的是中继方式；
6. 将root的脚本，配置700的权限，因为开发也有服务器权限，不能看到里面的密码。
7. 办公网，给运维部署域环境，并且启用nids 
8. 做了数据库加密系统，直接修改数据库不好使，只能用程序修改。直接看数据库全是密文的
9. 面对现在安全事故这么多，我有方法可以解决：做不好就工资全扣，我一分不要，再不好就开除我：1. 我提出来的安全策略让运维尽快执行2. 我提出来的数据库安全系统，咱们得用，3. 内网安全，咱们用自己的局域网，我来部署安全系统4. 世界杯后需要开发配合。因为太多代码漏洞和开发办公电脑导致的，分不清5. 把云账号和巡检交出去，我一人扛起安全的责任，但是不能没时间做，每天4小时没有了。6. 我这次早点主动和你沟通7. 我在整理所有黑客入侵漏洞和预案还有病毒分析整理
安全理念：三权分立
授权的权限、配置的权限、审计的权限
事前：防御
事中：控制
事后：溯源
整个过程要集中化管理和报警和审计，这就是siem系统
日志和审计的原理：时间地点人物、起因经过结果



普通用户千万不能有root权限，否则会看到root所有的日志，包括密码，甚至会有所有的root信息
使用isaudit公司的gvm 景象，可以免费使用最新版的openvas。
学习网络安全网站，rootme

安全处理问题的原则：
安全无小事，宁可错杀一百不可放过一个，因为一出事就是大的损失。经济损失和影响业务
安全做事原则：
不是哪个点做的多么细节，而是木桶原理，没有一个最弱的点，所有环节全面都考虑在内。取决于最弱的一环；
安全最弱的一环，永远都是人
加密是安全最核心的技术
攻击核心技术就是抓包改包，重放包
零信任系统就是vpn+认证系统，对每个请求都做验证和鉴权，就像一个保安随时跟着你。
很多代理和加密都是可以破解的，因为常见加密算法和密钥枚举技术就可以解密，比如代理服务器就能破解，有的vpn也能破解
下一代防火墙根据协议特征进行对应用进行判断，直接屏蔽协议，而不是端口了。比如只要用3389的RDP协议，就屏蔽，不管端口
防火墙对数据包病毒检测功能，很重要
安全漏洞威胁（即使不出网也会有的）：
1. 服务器文件的增删改查；
2. SQL注入，执行sql语句
3. XSS返回浏览器js代码。远控浏览器；
4. 获取电脑密码，等敏感信息；
被禁止出网后，还有http代理木马和dns隧道木马漏洞
在服务器上执行命令，可以看到服务器所有信息，包括脚本里的密码；
控制办公电脑，就可以沦陷所有服务器；
云主机被控制
XXE漏洞可以让主机执行命令
正向shell
用正向shell，远控内网所有服务器，有漏洞的应用可开启正向shell；
通过jumpserver，cmdb，Jenkins还是可以入侵内网所有主机；
遗留木马
机房物理攻击不算
知道机房Ip，从而ddos打死
远控白名单机器，（服务器就可以出网了）从而远控机房所有服务器
内网始终还是有能出网的机器，比如网络设备，esxi，代理服务器，F5，所以还是有可能出网的，没有绝对的不出网；
远控web后台，控制nacos，gitlab,域名系统，cmdb, 云平台，运营后台。
通过zabbix执行命令，也可以通过zabbix做正向shell
前员工是否还有权限
加白的第三方还可以让服务器出网，进而控制所有服务器
使用有木马的镜像或第三方库，就可以执行任何指令；
离职员工透漏漏洞，配合黑客入侵，因为百密一疏，总有还能出网的机器，一台就够；
有任何对外的端口都执行远控，比如smb，ftp，不一定就是web应用；
自己员工一个小失误就导致被黑客入侵内网，所以需要做纵深防御，而不是仅一种方法
使用有木马的应用，就可以让黑客正向连接，远控。只要远控一台就整个机房沦陷；
改git代码，让所有服务器执行命令
这是个非常好的渗透文章，得学习
威胁源点：
1. 友商
2. 运营商
3. 第三方
4. git代码库
5. 前雇员
6. 数据贩子
7. 竞争对手
8. 红客；
9. 中间批发商
10. 木马后门
11. 应用逻辑漏洞
12. 社会工程
13. 物理：地震，雷雨，识货，供电
14. 网络通信故障
15. 硬件故障
16. 系统漏洞
17. 内部人员，内鬼
18. 黑客渗透
安全威胁模型，用于威胁建模（找风险点和攻击路径）
1. MITRE ATT&CK
2. STRIDE
3. trike octotrike
4. seasponge
5. owasp-threat-dragon
6. ptatechnologies.com
用于威胁建模的资产：
1. 基础设施；
2. 系统代码；
3. 敏感信息；
4. Logs日志；
5. 数据访问接口；
6. 服务器控制权；
7. 数据库
8. 财务数据，如银行卡号；
9. 虚拟货币和信用卡号，游戏账号；
10. 家庭路由器、网络IOT设备
11
威胁情报平台：
https://x.threatbook.com/
https://community.riskiq.com/
https://ti.360.net/
https://www.virustotal.com/
https://otx.alienvault.com/
https://poma.nsfocus.com/
https://redqueen.tj-un.com/IntelHome.html







































安全防御的一个思路：
防御访问路径，就是谁能够访问谁，通过什么路径访问的，其余路径全部视为攻击。
比如用户访问注册表可以，但程序访问注册表就是攻击了
网络的span技术可以监控到交换机系统的任何一个端口
大部分攻击来自内部网络，所以要做内网安全
安全工作就四个方面：
1. 安全策略配置和规范执行；
2. 补丁管理
3. 安全系统维护
4. 紧急应急；
5. 红蓝对抗和白盒渗透
日志要有如下记录：
1. IP
2. 登录用户名
3. 时间
4. 协议
5. 数据包内容
6. 状态检测
7. 操作了什么
8. 应用识别
9. 从哪里操作的（堡垒机还是直连ssh还是web漏洞）
10. 造成了什么影响
11. 哪个进程执行的
12. 调用了什么函数
13. 目的IP
14. 目的端口
15. 什么命令操作的
16. 操作了哪个目标文件
17. 木马的进程ID

70%安全威胁来自于企业内部，由于企业内部终端数量多，人员层次不同，流动性大，安全意识薄弱，终端乱用资源，非授权访问，恶意终端破坏，信息泄密
事前预防，事中控制，事后溯源
有webshell的程序（php/asp/aspx/jsp/nodejs/python/perl/ruby/lua）
安全就是做这几部分：
用这几部分套所有的技术，就能做所有领域安全，比如运维安全，web应用安全等。安全的每一个点，都要满足如下这几条。
1. 数据私密性，加密
2. 数据完整性
3. 可靠性
4. 访问控制
5. 不可否认性
6. 可审计性，用户，应用，内容，怎么来的，做了什么。
7. 安全意识和规范
8. 做技术的基本素质
9. 应急响应
10. 找漏洞，漏洞管理
11. 沟通与协调能力
12. 渗透
13. 安全知识，知道所有攻击手段，防御方法
14. 知道所有类型的安全产品
15. 提安全事件解决方案
16. 经验，形成条件反射
17. 做人

安全一大原则： 不要想当然原则。
有的事，你觉得不可能，实际就是可能的，还得和技术去确认。
比如10.0.0.8网段的机器，根据日志去连接192.168.0.10的代理服务器。正常就觉得这条是假的，误报。实际，确实如此，网络就这么做的
安全一大原则：
不要怕麻烦原则
有的事就怕麻烦别人，或者自己麻烦，没有去仔细判断，结果导致重要线索浪费了。就像找特征码的时候，没有反复让运维查服务器，特征码没找到准确的
安全一大重要工作：
通过木马分析找特征码，进行所有服务器扫描
黑客经验：
如果找到黑客IP，就看防火墙历史记录，或NIDS历史记录，哪台服务器连接了这个黑客IP。
入侵都是apt形式，都会做内网横向，所以不仅仅一台，发现一台，一定要通过特征码找其他机器，是否也有木马。
通过特征码找其他已被远控的机器
要常看日志，看看不需要上网的机器上网了，那就是被有异常。要去排查
安全处理的一切核心就是找到木马（也就是检测到入侵的证据）。
然后分析木马的特征码和黑客IP。最终所有被入侵机器都找出来。结合网络设备日志找其他受感染机器。
所以一定要强烈要求用更多的HIDS来检测木马；
发现异常，查服务器的步骤：
1. 所有机器扫一遍这个进程名：kthread-xxx
2. 需要连接Mysql的服务器都统计下，Mysql做内网的白名单（内网都不准主动出，ip白名单可以入）；
3. 中木马的机器做出网白名单，这个是基于内网的，就是内网也不准出；
4. 把这台机器换掉；有的木马确实就解决不了。
5. 用NIDS监控内网间流量，尤其是DB区域的；
6. 对这台肉机进行抓包，tcpdump，然后进行分析特征，找到真实的远控肉机。
7. 世界杯期间要有万能备用机，随时可以启用，遇到木马就换机器。
8. 如果MySQL密码改了，黑客还能再次修改数据库，那证明肉机就是有密码的机器，比如代码服务器，比如配置中心；
9. 数据库的连接如果是未加密的，那么黑客可以在内网做中间人抓到密码。无解。数据库连接用加密的方式吧；
10. 做一台MySQL防火墙，对异常连接直接屏蔽并报警；
11. 数据库密码改一次，并且不告诉开发，用配置中心系统，对开发是透明的。
12. 通过这台机器，进行抓包，把另一台远控机器找出来，我写tcpdump脚本；最后结合mysql触发器确定时间，从而找到另外的肉机；
13. 对部分机器做只允许源端口出网。因为一台机器就一个docker，也就是一个进程，就做只允许这个进程的端口出网，包括出内网和外网；
14. iptables做内网的只允许入，并且指定到端口和ip。
15. 如果有端口复用的木马，那只能改变一下服务端口号了。
16. 使用腾讯云的安全中心在扫一次；
17. 在数据库前加一个四层代理，这样木马就不知道怎么连数据库了，数据库只允许代理访问。
18. 把nodejs代码给我，我做一下木马分析，尽量找到疑似的木马；
19. 在脚本服务器上安装webshell检测程序，如果发现webshell，就报警；
抓到肉机的方法：
1. 在网络设备，进行抓包，把除了6379的包都判断一下，找到其他远控主机的IP；
2. 搭建NIDS系统，因为黑可以获得的肉机一定会做横向渗透，扩大攻击面，就把这台机器抓出来；
安全一大原则：
一定要懂原理，思考原理，思路不能错，要清晰；
分几部分组成的；
Inotify使用手册
把所有文件md5计算一下，然后根据木马的md5，来判断是否被入侵了
安全就要做策略，把黑客攻击路径堵住，剩下的在做入侵检测。堵不住的包括正常业务的内容和程序本身的特点
Dns 隧道攻击特征：
1. 直接抓包，dns数据包大
2. 回应包都是base64类型数据
3. 大量dns数据包，几乎一秒一个
4. 类型都是txt或不常用类型，几乎没有a记录
5. DNS隧道每次终端发起请求只改变子域部分
6. 域名长度过长就是dns隧道
7. 一个请求对应多个相应。
8. 相应包是加密的
9. 流量上传下载比例大，因为要么只接受
10. 大量的子域名
11. DNS 包是明文的发现加密包就是dns隧道
12. 在一段时间内，大量的dns包
13
DNS隧道精准抓包
云主机安全策略
3.1 打补丁，按照附件一操作即可；
3.2 所有应用程序（或称为服务）不以root启用，以普通用户启动（这是重中之重）
3.3 服务器不能主动出网
3.4 对内的应用访问使用白名单，对黑客隐藏；对外访问的不用；并且使用二次验证
3.5 只允许堡垒机登录，ssh不允许其他IP登录；
3.6 只开放有用的端口，比如80和443和22
入侵检测的一个方法：
找到木马文件后，运行tripwire和inotify，在启动tcpdump，最后启动木马，看木马都生成了哪些文件，还有哪个IP+port，对其他服务器做扫描就行
webshell在线查杀就用baidu+，webdir+
主机版查杀，就用河马或其他安全软件
这个网站分析木马和virustotal一样优秀
nethogs监控每个进程的流量
Fail2ban监控日志里的ip, 发现频率过高就联动防火墙黑名单，还可以限时恢复。应用于任何日志
ModSecurity+comdo waf规则集 + fail2ban
逆向思维
内网访问生产服务器用一个统一入口，就在这个入口做入侵检测；WAF+fail2ban
代码审计和WAF结合到代码快速发布里面，devsecops
木马分析网站


被禁止出网后，还有http代理木马和dns隧道木马漏洞
如果服务器不能出网，也没有文件上传漏洞，那么即使有RCE，黑客也无法上传木马。同事要卸载wget、curl等命令
在黑客没有代理程序的时候，就必须使用服务器自带的命令，只要把服务器命令控制住就行了；
内网访问生产服务器用一个统一入口，就在这个入口做入侵检测；WAF+fail2ban
如果有劫持得看nginx是否被入侵了
应急响应文档：
使用多级代理上网的方法：
1. 客户端用v2ray
2. 中转节点用xui 
3. 落地节点用xui
代理服务器平时需要关闭，因为木马可以从代理走
Jenkins安全加固：
开发电脑被远控，然后入侵Jenkins，这样防不住；
1. Jenkins服务器不允许安装其他应用；
2. 内网除80、443不允许其他服务访问进来（INPUT）。
3. 外层加一个modsecurity的WAF。最好放在外网，不影响现有架构。
4. 安装clamAV杀软；
5. 以普通用户启动；
6. 禁用：lrzsz/ftp/rsync/rcp/scp/sftp/wget/curl/yum;
7. 打上两个提权补丁；
8. 其余根据我做WAF联调，才能提出具体的加固项；
9. 服务器不主动出网，只有进程才能出网，系统不能使用代理出网
DevSecOps
Gitlab + SonarQube实现代码扫描，可实现左移。实现SAST。
Gitlab+Jenkins+SonarQube 实现代码审计
维护WAF规则集的组织：
1. netnea公司还维护了一套类CRS规则库
https://www.netnea.com/cms/core-rule-set-inventory/#crs-table-942100
2. AtomiCorp 版本规则
https://atomicorp.com/free-modsecurity-rules/
3. Comodo 版本规则
https://waf.comodo.com/
WAF继续配置：
1. 防止php的扫描；
2. 防止文件上传，对http包限制；
3. 让真人把现在的nginx 给停了，不然用hosts就绕过waf了
WAF测试平台：
1. pikachu靶场；
2. gotestwaf
https://github.com/wallarm/gotestwaf
什么叫被入侵了，
1. 进程执行了异常指令
2. 系统里多了后门
3. 系统文件被篡改了
4. 对外发起网络请求
安全需要有慧眼，看得远，知道该做什么，什么时候做什么
提取一段时间内的出网IP，来分析是否有恶意IP
找木马和后门的步骤：
1. 定位网络；
2. 定位主机（通过网络连接和威胁情报和NIDS报警）
3. 找应用漏洞，系统日志；
4. 可能人为上传木马；
5. 利用杀软和HIDS找到木马和后门。
6. 分析木马，找其他机器的木马；
经常mtr看一下或arp看有没有重复的mac地址。因为会有内网中间人攻击；
1. 抓arp包，找到受害主机
2. 根据arp结果，过滤网关的up 地址的错误mac 地址，就是被入侵机器
3. 用交换机配置DAI解决arp攻击
4. 每台机器上做arp静态绑定即可
5. 安装arp防火墙
6. 用交换机有arp安全的功能
有一个it世界和真实世界关联的方法，谁叫谁小狗。
就把一个ip 踢下线，谁说没网络，这个ip 就是他
安全思维要懂得缩小范围，先做策略缩小范围，在做入侵检测
使用trivy扫描镜像，对镜像的漏洞心中有数，就一条命令（trivy image Jenkins）
如果Jenkins必须要上网，那就用master - slave模式，master只负责和用户连接，管理。slave可以出网，执行命令
安全要能够保障上线，运维开发DBA网络是要保障下线。所以安全要专注于安全技术，不要关心底层技术内容。不然出问题大家都搞不定
防止黑客入侵服务器：
即使黑客远控我电脑了。
黑客攻击的特点是，必须用黑客工具去攻击。也可以是一个python脚本。
所以，就让黑客的脚本连不到服务器就行了，即使黑客把我电脑给黑了，也连不上服务器。
就在我电脑里用远程桌面访问服务器，黑客即使能看到我的桌面，但是他的工具或脚本连不到服务器。
也就是说我连服务器走的不是http协议，黑客无法走我们用的协议，所以即使黑客远控我电脑也入侵不了服务器
这个思维特点就是套娃思维。改变协议就行了。
在现有协议上套一层协议，既能满足业务，又防御了黑客
windows远程桌面安全
所有人的远程桌面把权限降到最低；
1. 应用程序白名单；
2. 进程白名单；
3. 进程防火墙；
4. user组
5. 复杂密码
Windows安全：
1. 所有用户使用普通用户，并且users组，administrator使用云平台或vmware管理；
2. 应用白名单；
3. 进程白名单；
4. 防火墙，基于进程的。
5. 不能入，不能出，只做白名单




IT一大特点，熟悉环境：
1. 就算是java开发，也得熟悉http和操作系统环境；
2. 就算是C开发，也得熟悉系统内核的环境；
3. 熟悉环境太重要了，就像安全得熟悉整个运维架构才能工作。
写一个信息采集脚本，当服务器安全告警后，就立即采集信息，然后就可以关机等方式处理应急。将损失降到最低
定期做一个全面的安全巡检，就像全面的身体检查一样。
进程对应的用户，千万不能有/bin/bash， 不然就被反弹shell了。
不能反弹shell，也不能上传木马，几乎就不会被远控了
一个很重要的安全思维：
要限制黑客的攻击路径，至少让他突破两个点才能拿到资源；
比如，目标资源就是服务器，那就先远控员工电脑，员工通过虚拟桌面访问服务器，黑客就拿不到服务器资源了。
再加上入侵检测，当黑客突破第一道防线，在突破第二道防线的路上就部署入侵检测系统，把黑客入侵痕迹扫描出来即可；
简单说，黑客先进入入口，然后想获取更多的资源，就让他没权限，在提权的时候就入侵检测；
也可以让他进入入口后，没有访问资源的白名单，获取另一台机器的权限才可以；这就是NIDS的工作了，能扫描出每台主机的网络行为；
HIDS要有提权的检测
unixhot WAF
完全自定义的WAF，只有框架没有规则
运维系统要做访问先频率，和记录日志，这样就知道谁在攻击，主要是看日志，用fail2ban就行
有的漏洞EXP也就是访问几次服务器，大概4次请求就黑掉服务器。
所以要有日志报警，2秒钟请求超过1次的就报警。最好是ELK加esalert模块，或者写个脚本就行
接口被攻击解决方法：
1. ip白名单；
2. 限制频率；
3. 双向证书；
4. 请求加签名；
5. 参数合法性校验；
6. 最后不行让前后端配合加个验证码；
7. 做一层人机识别，最简单的用验证是否是浏览器，比如五秒盾。只要识别不是伪造IP就行，代理IP没有那么多，通过限制频率可以防住的。
8. 对session进行验证，必须确认用户登录成功；
9. 通过session来做频率限制；
10. 定期检查日志，丢异常接口访问进行排查；
11
GDPR 合规性，通用数据保护法规是十年来整个欧盟 IT 领域最显着的发展
在代理服务器上启用日志，就看服务器的请求有没有恶意的，如果有，那就是被http木马远控了。重做系统即可
容器安全检测工具之一：docker bench/trivy
容器运行时检测工具：DockerENT
开启 Docker Content Trust ， 启用镜像校验功能
持续监控镜像安全漏洞：
snyk monitor --docker node:10
查看dockerfile中的是否包含敏感信息； 用户密钥什么的
镜像容易遭遇供应链攻击，黑客直接把镜像给修改了
体育平台潜在安全威胁


一、 整理当前攻击路径（运维相关）：
1. 黑掉运维的个人电脑；
2. 远控开发或客服电脑，然后渗透web应用，大都是后台应用，就能远控应用服务器；
3. 利用网站的web漏洞，直接远控机房里的应用服务器；
4. 所有应用，只要黑客能访问到应用，他就能远控服务器；
5. 机房内有肉机，比如防火墙，从而内网横向渗透；
6. 机房物理事故故障；
7. 办公网有肉机，不断渗透堡垒机等运维漏洞，谁都不能保证应用程序有0day漏洞；
8. 远程运维电脑被入侵；
9. 运维远程办公机（云桌面）被入侵；
10. 入侵云主机，做劫持；
11. 从机房控制IPMI，从而远控服务器；
12. 内应通过脚本执行，这个无法防御；
13. 开发自建的监控系统，如果有登录或操作接口，就很可能有漏洞，大家都能访问，这台服务器就可能被远控；
14. 肯定有出口白名单，黑客远控白名单的服务器，进而远控机房服务器；
15. 用dns隧道做远控，或者ping隧道做远控，只要能对外ping或dns请求，就能远控了。
16. 替换掉harbor上和本地的镜像，注入一层程序，就可以做java内存马，从而直接就可以访问，就和webshell一样；
17. 黑客远控大家的寝室办公电脑，从而入侵系统；
18. 目前看黑客已拿到公司的源码，并且做了代码审计，可以通过代码执行命令，只是无法做进一步的远控；
19. 有对外的邮箱或ftp系统，都可能有漏洞被入侵；
20. 先入侵VPN服务器，就有白名单，做进一步渗透了。
21. 黑掉git服务器，直接改代码，自己写一个漏洞上去，即可实现远程命令执行；
22. 对php的应用，直接注入webshell，不用机器出网也可以入侵；
23. 对机房的外网IP直接扫描，只要开启端口的就实施渗透。这就是原站入侵；
24. 机房服务器需要访问第三方服务器或自己的外网应用，黑客把这台服务器黑掉就行，这叫水坑攻击；
25

二、 修改数据库的攻击链
1. 所有能操作数据库的web应用，都可能被入侵后，直接修改数据库；
2. web应用有漏洞，黑客直接正常访问，添加参数即可利用漏洞，就能修改数据库；
3. 尤其是yearning系统或phpmyadmin系统，被黑客登录web页面后，就可以修改数据库；
4


三、 从机房角度检测到入侵事件：
3. 做arp抓包，看看有没有内网中间人攻击；
4. 离线的安骑士，立刻安装腾讯云ids；
5. 蜜罐系统
6. tripwire系统，监控改动的文件和增加的文件；
7. inotify系统，从内核层监控文件修改记录；
8. clamAV系统，就是Linux的杀软；
9. 把所有php程序都扫一遍webshell，安装HM实时扫描webshell程序，正向shell；
10. 运维应用都不允许直接访问，能直接访问的在做安全加固；
11. 和网络工程师要一个当前的配置，整理还能出网的IP。就看他是否给防火墙和交换机，因为就看他是否漏项；
12. 办公室ip到运维系统全部黑名单，只留开发的，剩下的都是开发的锅
13. 使用trivy或docker bench security扫描漏洞；
14. 堡垒机前面加一个waf。运维能直接访问的web应用前面都加一个waf；
15. 所有的zabbix-agent去掉命令执行功能，EnableRemoteCommands=0即可；
16. 所有web口令一定要复杂，最好有二次验证，并且3个月改一次密码；
17. IPMI接口，ESXI，Vcenter做加固，做白名单；
18. 应用程序已普通用户启动，普通用户不要有shell。
19

四、 攻击面记录：
1. 统计运维web应用系统。比如xxl-job， phpmyadmin，Jenkins，zabbix，prometheus，jumpserver，yearning，grafana，flink，
2. 把不允许访问数据库的，全部添加数据库黑名单；
3. 办公室电脑全部重做系统；
4. 防0day的策略
5. 容器安全
